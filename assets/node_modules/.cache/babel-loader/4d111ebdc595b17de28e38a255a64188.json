{"ast":null,"code":"/*\n * Copyright 2017-2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"). You may not use this file except in compliance with\n * the License. A copy of the License is located at\n *\n *     http://aws.amazon.com/apache2.0/\n *\n * or in the \"license\" file accompanying this file. This file is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR\n * CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions\n * and limitations under the License.\n */\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n    label: 0,\n    sent: function sent() {\n      if (t[0] & 1) throw t[1];\n      return t[1];\n    },\n    trys: [],\n    ops: []\n  },\n      f,\n      y,\n      t,\n      g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n\n    while (_) {\n      try {\n        if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n        if (y = 0, t) op = [op[0] & 2, t.value];\n\n        switch (op[0]) {\n          case 0:\n          case 1:\n            t = op;\n            break;\n\n          case 4:\n            _.label++;\n            return {\n              value: op[1],\n              done: false\n            };\n\n          case 5:\n            _.label++;\n            y = op[1];\n            op = [0];\n            continue;\n\n          case 7:\n            op = _.ops.pop();\n\n            _.trys.pop();\n\n            continue;\n\n          default:\n            if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n              _ = 0;\n              continue;\n            }\n\n            if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n              _.label = op[1];\n              break;\n            }\n\n            if (op[0] === 6 && _.label < t[1]) {\n              _.label = t[1];\n              t = op;\n              break;\n            }\n\n            if (t && _.label < t[2]) {\n              _.label = t[2];\n\n              _.ops.push(op);\n\n              break;\n            }\n\n            if (t[2]) _.ops.pop();\n\n            _.trys.pop();\n\n            continue;\n        }\n\n        op = body.call(thisArg, _);\n      } catch (e) {\n        op = [6, e];\n        y = 0;\n      } finally {\n        f = t = 0;\n      }\n    }\n\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\n\nimport { isUsernamePasswordOpts, isCognitoHostedOpts, isFederatedSignInOptions, isFederatedSignInOptionsCustom } from './types';\nimport { AWS, ConsoleLogger as Logger, Constants, Hub, JS, Parser, Credentials, StorageHelper } from '@aws-amplify/core';\nimport { CookieStorage, CognitoUserPool, AuthenticationDetails, CognitoUser, CognitoUserSession, CognitoUserAttribute, CognitoIdToken, CognitoRefreshToken, CognitoAccessToken } from 'amazon-cognito-identity-js';\nimport { parse } from 'url';\nimport OAuth from './OAuth/OAuth';\nimport { default as urlListener } from './urlListener';\nimport { AuthError, NoUserPoolError } from './Errors';\nimport { AuthErrorTypes } from './types/Auth';\nvar logger = new Logger('AuthClass');\nvar USER_ADMIN_SCOPE = 'aws.cognito.signin.user.admin';\nvar AMPLIFY_SYMBOL = typeof Symbol !== 'undefined' && typeof Symbol.for === 'function' ? Symbol.for('amplify_default') : '@@amplify_default';\n\nvar dispatchAuthEvent = function dispatchAuthEvent(event, data, message) {\n  Hub.dispatch('auth', {\n    event: event,\n    data: data,\n    message: message\n  }, 'Auth', AMPLIFY_SYMBOL);\n};\n\nexport var CognitoHostedUIIdentityProvider;\n\n(function (CognitoHostedUIIdentityProvider) {\n  CognitoHostedUIIdentityProvider[\"Cognito\"] = \"COGNITO\";\n  CognitoHostedUIIdentityProvider[\"Google\"] = \"Google\";\n  CognitoHostedUIIdentityProvider[\"Facebook\"] = \"Facebook\";\n  CognitoHostedUIIdentityProvider[\"Amazon\"] = \"LoginWithAmazon\";\n})(CognitoHostedUIIdentityProvider || (CognitoHostedUIIdentityProvider = {}));\n/**\n * Provide authentication steps\n */\n\n\nvar AuthClass =\n/** @class */\nfunction () {\n  /**\n   * Initialize Auth with AWS configurations\n   * @param {Object} config - Configuration of the Auth\n   */\n  function AuthClass(config) {\n    var _this = this;\n\n    this.userPool = null;\n    this.user = null;\n    this.configure(config);\n    this.currentUserCredentials = this.currentUserCredentials.bind(this);\n\n    if (AWS.config) {\n      AWS.config.update({\n        customUserAgent: Constants.userAgent\n      });\n    } else {\n      logger.warn('No AWS.config');\n    }\n\n    Hub.listen('auth', function (_a) {\n      var payload = _a.payload;\n      var event = payload.event;\n\n      switch (event) {\n        case 'signIn':\n          _this._storage.setItem('amplify-signin-with-hostedUI', 'false');\n\n          break;\n\n        case 'signOut':\n          _this._storage.removeItem('amplify-signin-with-hostedUI');\n\n          break;\n\n        case 'cognitoHostedUI':\n          _this._storage.setItem('amplify-signin-with-hostedUI', 'true');\n\n          break;\n      }\n    });\n  }\n\n  AuthClass.prototype.getModuleName = function () {\n    return 'Auth';\n  };\n\n  AuthClass.prototype.configure = function (config) {\n    var _this = this;\n\n    if (!config) return this._config || {};\n    logger.debug('configure Auth');\n    var conf = Object.assign({}, this._config, Parser.parseMobilehubConfig(config).Auth, config);\n    this._config = conf;\n    var _a = this._config,\n        userPoolId = _a.userPoolId,\n        userPoolWebClientId = _a.userPoolWebClientId,\n        cookieStorage = _a.cookieStorage,\n        oauth = _a.oauth,\n        region = _a.region,\n        identityPoolId = _a.identityPoolId,\n        mandatorySignIn = _a.mandatorySignIn,\n        refreshHandlers = _a.refreshHandlers,\n        identityPoolRegion = _a.identityPoolRegion,\n        clientMetadata = _a.clientMetadata;\n\n    if (!this._config.storage) {\n      // backward compatbility\n      if (cookieStorage) this._storage = new CookieStorage(cookieStorage);else {\n        this._storage = new StorageHelper().getStorage();\n      }\n    } else {\n      if (!this._isValidAuthStorage(this._config.storage)) {\n        logger.error('The storage in the Auth config is not valid!');\n        throw new Error('Empty storage object');\n      }\n\n      this._storage = this._config.storage;\n    }\n\n    this._storageSync = Promise.resolve();\n\n    if (typeof this._storage['sync'] === 'function') {\n      this._storageSync = this._storage['sync']();\n    }\n\n    if (userPoolId) {\n      var userPoolData = {\n        UserPoolId: userPoolId,\n        ClientId: userPoolWebClientId\n      };\n      userPoolData.Storage = this._storage;\n      this.userPool = new CognitoUserPool(userPoolData);\n    }\n\n    Credentials.configure({\n      mandatorySignIn: mandatorySignIn,\n      region: identityPoolRegion || region,\n      userPoolId: userPoolId,\n      identityPoolId: identityPoolId,\n      refreshHandlers: refreshHandlers,\n      storage: this._storage\n    }); // initiailize cognitoauth client if hosted ui options provided\n    // to keep backward compatibility:\n\n    var cognitoHostedUIConfig = oauth ? isCognitoHostedOpts(this._config.oauth) ? oauth : oauth.awsCognito : undefined;\n\n    if (cognitoHostedUIConfig) {\n      var cognitoAuthParams = Object.assign({\n        cognitoClientId: userPoolWebClientId,\n        UserPoolId: userPoolId,\n        domain: cognitoHostedUIConfig['domain'],\n        scopes: cognitoHostedUIConfig['scope'],\n        redirectSignIn: cognitoHostedUIConfig['redirectSignIn'],\n        redirectSignOut: cognitoHostedUIConfig['redirectSignOut'],\n        responseType: cognitoHostedUIConfig['responseType'],\n        Storage: this._storage,\n        urlOpener: cognitoHostedUIConfig['urlOpener'],\n        clientMetadata: clientMetadata\n      }, cognitoHostedUIConfig['options']);\n      this._oAuthHandler = new OAuth({\n        scopes: cognitoAuthParams.scopes,\n        config: cognitoAuthParams,\n        cognitoClientId: cognitoAuthParams.cognitoClientId\n      }); // **NOTE** - Remove this in a future major release as it is a breaking change\n\n      urlListener(function (_a) {\n        var url = _a.url;\n\n        _this._handleAuthResponse(url);\n      });\n    }\n\n    dispatchAuthEvent('configured', null, \"The Auth category has been configured successfully\");\n    return this._config;\n  };\n  /**\n   * Sign up with username, password and other attrbutes like phone, email\n   * @param {String | object} params - The user attirbutes used for signin\n   * @param {String[]} restOfAttrs - for the backward compatability\n   * @return - A promise resolves callback data if success\n   */\n\n\n  AuthClass.prototype.signUp = function (params) {\n    var _this = this;\n\n    var restOfAttrs = [];\n\n    for (var _i = 1; _i < arguments.length; _i++) {\n      restOfAttrs[_i - 1] = arguments[_i];\n    }\n\n    if (!this.userPool) {\n      return this.rejectNoUserPool();\n    }\n\n    var username = null;\n    var password = null;\n    var attributes = [];\n    var validationData = null;\n    var clientMetadata;\n\n    if (params && typeof params === 'string') {\n      username = params;\n      password = restOfAttrs ? restOfAttrs[0] : null;\n      var email = restOfAttrs ? restOfAttrs[1] : null;\n      var phone_number = restOfAttrs ? restOfAttrs[2] : null;\n      if (email) attributes.push({\n        Name: 'email',\n        Value: email\n      });\n      if (phone_number) attributes.push({\n        Name: 'phone_number',\n        Value: phone_number\n      });\n    } else if (params && typeof params === 'object') {\n      username = params['username'];\n      password = params['password'];\n\n      if (params && params.clientMetadata) {\n        clientMetadata = params.clientMetadata;\n      } else if (this._config.clientMetadata) {\n        clientMetadata = this._config.clientMetadata;\n      }\n\n      var attrs_1 = params['attributes'];\n\n      if (attrs_1) {\n        Object.keys(attrs_1).map(function (key) {\n          var ele = {\n            Name: key,\n            Value: attrs_1[key]\n          };\n          attributes.push(ele);\n        });\n      }\n\n      validationData = params['validationData'] || null;\n    } else {\n      return this.rejectAuthError(AuthErrorTypes.SignUpError);\n    }\n\n    if (!username) {\n      return this.rejectAuthError(AuthErrorTypes.EmptyUsername);\n    }\n\n    if (!password) {\n      return this.rejectAuthError(AuthErrorTypes.EmptyPassword);\n    }\n\n    logger.debug('signUp attrs:', attributes);\n    logger.debug('signUp validation data:', validationData);\n    return new Promise(function (resolve, reject) {\n      _this.userPool.signUp(username, password, attributes, validationData, function (err, data) {\n        if (err) {\n          dispatchAuthEvent('signUp_failure', err, username + \" failed to signup\");\n          reject(err);\n        } else {\n          dispatchAuthEvent('signUp', data, username + \" has signed up successfully\");\n          resolve(data);\n        }\n      }, clientMetadata);\n    });\n  };\n  /**\n   * Send the verfication code to confirm sign up\n   * @param {String} username - The username to be confirmed\n   * @param {String} code - The verification code\n   * @param {ConfirmSignUpOptions} options - other options for confirm signup\n   * @return - A promise resolves callback data if success\n   */\n\n\n  AuthClass.prototype.confirmSignUp = function (username, code, options) {\n    if (!this.userPool) {\n      return this.rejectNoUserPool();\n    }\n\n    if (!username) {\n      return this.rejectAuthError(AuthErrorTypes.EmptyUsername);\n    }\n\n    if (!code) {\n      return this.rejectAuthError(AuthErrorTypes.EmptyCode);\n    }\n\n    var user = this.createCognitoUser(username);\n    var forceAliasCreation = options && typeof options.forceAliasCreation === 'boolean' ? options.forceAliasCreation : true;\n    var clientMetadata;\n\n    if (options && options.clientMetadata) {\n      clientMetadata = options.clientMetadata;\n    } else if (this._config.clientMetadata) {\n      clientMetadata = this._config.clientMetadata;\n    }\n\n    return new Promise(function (resolve, reject) {\n      user.confirmRegistration(code, forceAliasCreation, function (err, data) {\n        if (err) {\n          reject(err);\n        } else {\n          resolve(data);\n        }\n      }, clientMetadata);\n    });\n  };\n  /**\n   * Resend the verification code\n   * @param {String} username - The username to be confirmed\n   * @param {ClientMetadata} clientMetadata - Metadata to be passed to Cognito Lambda triggers\n   * @return - A promise resolves data if success\n   */\n\n\n  AuthClass.prototype.resendSignUp = function (username, clientMetadata) {\n    if (clientMetadata === void 0) {\n      clientMetadata = this._config.clientMetadata;\n    }\n\n    if (!this.userPool) {\n      return this.rejectNoUserPool();\n    }\n\n    if (!username) {\n      return this.rejectAuthError(AuthErrorTypes.EmptyUsername);\n    }\n\n    var user = this.createCognitoUser(username);\n    return new Promise(function (resolve, reject) {\n      user.resendConfirmationCode(function (err, data) {\n        if (err) {\n          reject(err);\n        } else {\n          resolve(data);\n        }\n      }, clientMetadata);\n    });\n  };\n  /**\n   * Sign in\n   * @param {String | SignInOpts} usernameOrSignInOpts - The username to be signed in or the sign in options\n   * @param {String} password - The password of the username\n   * @return - A promise resolves the CognitoUser\n   */\n\n\n  AuthClass.prototype.signIn = function (usernameOrSignInOpts, pw, clientMetadata) {\n    if (clientMetadata === void 0) {\n      clientMetadata = this._config.clientMetadata;\n    }\n\n    if (!this.userPool) {\n      return this.rejectNoUserPool();\n    }\n\n    var username = null;\n    var password = null;\n    var validationData = {}; // for backward compatibility\n\n    if (typeof usernameOrSignInOpts === 'string') {\n      username = usernameOrSignInOpts;\n      password = pw;\n    } else if (isUsernamePasswordOpts(usernameOrSignInOpts)) {\n      if (typeof pw !== 'undefined') {\n        logger.warn('The password should be defined under the first parameter object!');\n      }\n\n      username = usernameOrSignInOpts.username;\n      password = usernameOrSignInOpts.password;\n      validationData = usernameOrSignInOpts.validationData;\n    } else {\n      return this.rejectAuthError(AuthErrorTypes.InvalidUsername);\n    }\n\n    if (!username) {\n      return this.rejectAuthError(AuthErrorTypes.EmptyUsername);\n    }\n\n    var authDetails = new AuthenticationDetails({\n      Username: username,\n      Password: password,\n      ValidationData: validationData,\n      ClientMetadata: clientMetadata\n    });\n\n    if (password) {\n      return this.signInWithPassword(authDetails);\n    } else {\n      return this.signInWithoutPassword(authDetails);\n    }\n  };\n  /**\n   * Return an object with the authentication callbacks\n   * @param {CognitoUser} user - the cognito user object\n   * @param {} resolve - function called when resolving the current step\n   * @param {} reject - function called when rejecting the current step\n   * @return - an object with the callback methods for user authentication\n   */\n\n\n  AuthClass.prototype.authCallbacks = function (user, resolve, reject) {\n    var _this = this;\n\n    var that = this;\n    return {\n      onSuccess: function onSuccess(session) {\n        return __awaiter(_this, void 0, void 0, function () {\n          var cred, e_1, currentUser, e_2;\n          return __generator(this, function (_a) {\n            switch (_a.label) {\n              case 0:\n                logger.debug(session);\n                delete user['challengeName'];\n                delete user['challengeParam'];\n                _a.label = 1;\n\n              case 1:\n                _a.trys.push([1, 4, 5, 9]);\n\n                return [4\n                /*yield*/\n                , Credentials.clear()];\n\n              case 2:\n                _a.sent();\n\n                return [4\n                /*yield*/\n                , Credentials.set(session, 'session')];\n\n              case 3:\n                cred = _a.sent();\n                logger.debug('succeed to get cognito credentials', cred);\n                return [3\n                /*break*/\n                , 9];\n\n              case 4:\n                e_1 = _a.sent();\n                logger.debug('cannot get cognito credentials', e_1);\n                return [3\n                /*break*/\n                , 9];\n\n              case 5:\n                _a.trys.push([5, 7,, 8]);\n\n                return [4\n                /*yield*/\n                , this.currentUserPoolUser()];\n\n              case 6:\n                currentUser = _a.sent();\n                that.user = currentUser;\n                dispatchAuthEvent('signIn', currentUser, \"A user \" + user.getUsername() + \" has been signed in\");\n                resolve(currentUser);\n                return [3\n                /*break*/\n                , 8];\n\n              case 7:\n                e_2 = _a.sent();\n                logger.error('Failed to get the signed in user', e_2);\n                reject(e_2);\n                return [3\n                /*break*/\n                , 8];\n\n              case 8:\n                return [7\n                /*endfinally*/\n                ];\n\n              case 9:\n                return [2\n                /*return*/\n                ];\n            }\n          });\n        });\n      },\n      onFailure: function onFailure(err) {\n        logger.debug('signIn failure', err);\n        dispatchAuthEvent('signIn_failure', err, user.getUsername() + \" failed to signin\");\n        reject(err);\n      },\n      customChallenge: function customChallenge(challengeParam) {\n        logger.debug('signIn custom challenge answer required');\n        user['challengeName'] = 'CUSTOM_CHALLENGE';\n        user['challengeParam'] = challengeParam;\n        resolve(user);\n      },\n      mfaRequired: function mfaRequired(challengeName, challengeParam) {\n        logger.debug('signIn MFA required');\n        user['challengeName'] = challengeName;\n        user['challengeParam'] = challengeParam;\n        resolve(user);\n      },\n      mfaSetup: function mfaSetup(challengeName, challengeParam) {\n        logger.debug('signIn mfa setup', challengeName);\n        user['challengeName'] = challengeName;\n        user['challengeParam'] = challengeParam;\n        resolve(user);\n      },\n      newPasswordRequired: function newPasswordRequired(userAttributes, requiredAttributes) {\n        logger.debug('signIn new password');\n        user['challengeName'] = 'NEW_PASSWORD_REQUIRED';\n        user['challengeParam'] = {\n          userAttributes: userAttributes,\n          requiredAttributes: requiredAttributes\n        };\n        resolve(user);\n      },\n      totpRequired: function totpRequired(challengeName, challengeParam) {\n        logger.debug('signIn totpRequired');\n        user['challengeName'] = challengeName;\n        user['challengeParam'] = challengeParam;\n        resolve(user);\n      },\n      selectMFAType: function selectMFAType(challengeName, challengeParam) {\n        logger.debug('signIn selectMFAType', challengeName);\n        user['challengeName'] = challengeName;\n        user['challengeParam'] = challengeParam;\n        resolve(user);\n      }\n    };\n  };\n  /**\n   * Sign in with a password\n   * @private\n   * @param {AuthenticationDetails} authDetails - the user sign in data\n   * @return - A promise resolves the CognitoUser object if success or mfa required\n   */\n\n\n  AuthClass.prototype.signInWithPassword = function (authDetails) {\n    var _this = this;\n\n    var user = this.createCognitoUser(authDetails.getUsername());\n    return new Promise(function (resolve, reject) {\n      user.authenticateUser(authDetails, _this.authCallbacks(user, resolve, reject));\n    });\n  };\n  /**\n   * Sign in without a password\n   * @private\n   * @param {AuthenticationDetails} authDetails - the user sign in data\n   * @return - A promise resolves the CognitoUser object if success or mfa required\n   */\n\n\n  AuthClass.prototype.signInWithoutPassword = function (authDetails) {\n    var _this = this;\n\n    var user = this.createCognitoUser(authDetails.getUsername());\n    user.setAuthenticationFlowType('CUSTOM_AUTH');\n    return new Promise(function (resolve, reject) {\n      user.initiateAuth(authDetails, _this.authCallbacks(user, resolve, reject));\n    });\n  };\n  /**\n   * get user current preferred mfa option\n   * this method doesn't work with totp, we need to deprecate it.\n   * @deprecated\n   * @param {CognitoUser} user - the current user\n   * @return - A promise resolves the current preferred mfa option if success\n   */\n\n\n  AuthClass.prototype.getMFAOptions = function (user) {\n    return new Promise(function (res, rej) {\n      user.getMFAOptions(function (err, mfaOptions) {\n        if (err) {\n          logger.debug('get MFA Options failed', err);\n          rej(err);\n          return;\n        }\n\n        logger.debug('get MFA options success', mfaOptions);\n        res(mfaOptions);\n        return;\n      });\n    });\n  };\n  /**\n   * get preferred mfa method\n   * @param {CognitoUser} user - the current cognito user\n   * @param {GetPreferredMFAOpts} params - options for getting the current user preferred MFA\n   */\n\n\n  AuthClass.prototype.getPreferredMFA = function (user, params) {\n    var that = this;\n    return new Promise(function (res, rej) {\n      var bypassCache = params ? params.bypassCache : false;\n      user.getUserData(function (err, data) {\n        if (err) {\n          logger.debug('getting preferred mfa failed', err);\n          rej(err);\n          return;\n        }\n\n        var mfaType = that._getMfaTypeFromUserData(data);\n\n        if (!mfaType) {\n          rej('invalid MFA Type');\n          return;\n        } else {\n          res(mfaType);\n          return;\n        }\n      }, {\n        bypassCache: bypassCache\n      });\n    });\n  };\n\n  AuthClass.prototype._getMfaTypeFromUserData = function (data) {\n    var ret = null;\n    var preferredMFA = data.PreferredMfaSetting; // if the user has used Auth.setPreferredMFA() to setup the mfa type\n    // then the \"PreferredMfaSetting\" would exist in the response\n\n    if (preferredMFA) {\n      ret = preferredMFA;\n    } else {\n      // if mfaList exists but empty, then its noMFA\n      var mfaList = data.UserMFASettingList;\n\n      if (!mfaList) {\n        // if SMS was enabled by using Auth.enableSMS(),\n        // the response would contain MFAOptions\n        // as for now Cognito only supports for SMS, so we will say it is 'SMS_MFA'\n        // if it does not exist, then it should be NOMFA\n        var MFAOptions = data.MFAOptions;\n\n        if (MFAOptions) {\n          ret = 'SMS_MFA';\n        } else {\n          ret = 'NOMFA';\n        }\n      } else if (mfaList.length === 0) {\n        ret = 'NOMFA';\n      } else {\n        logger.debug('invalid case for getPreferredMFA', data);\n      }\n    }\n\n    return ret;\n  };\n\n  AuthClass.prototype._getUserData = function (user, params) {\n    return new Promise(function (res, rej) {\n      user.getUserData(function (err, data) {\n        if (err) {\n          logger.debug('getting user data failed', err);\n          rej(err);\n          return;\n        } else {\n          res(data);\n          return;\n        }\n      }, params);\n    });\n  };\n  /**\n   * set preferred MFA method\n   * @param {CognitoUser} user - the current Cognito user\n   * @param {string} mfaMethod - preferred mfa method\n   * @return - A promise resolve if success\n   */\n\n\n  AuthClass.prototype.setPreferredMFA = function (user, mfaMethod) {\n    return __awaiter(this, void 0, void 0, function () {\n      var userData, smsMfaSettings, totpMfaSettings, _a, mfaList, currentMFAType, that;\n\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , this._getUserData(user, {\n              bypassCache: true\n            })];\n\n          case 1:\n            userData = _b.sent();\n            smsMfaSettings = null;\n            totpMfaSettings = null;\n            _a = mfaMethod;\n\n            switch (_a) {\n              case 'TOTP' || 'SOFTWARE_TOKEN_MFA':\n                return [3\n                /*break*/\n                , 2];\n\n              case 'SMS' || 'SMS_MFA':\n                return [3\n                /*break*/\n                , 3];\n\n              case 'NOMFA':\n                return [3\n                /*break*/\n                , 4];\n            }\n\n            return [3\n            /*break*/\n            , 6];\n\n          case 2:\n            totpMfaSettings = {\n              PreferredMfa: true,\n              Enabled: true\n            };\n            return [3\n            /*break*/\n            , 7];\n\n          case 3:\n            smsMfaSettings = {\n              PreferredMfa: true,\n              Enabled: true\n            };\n            return [3\n            /*break*/\n            , 7];\n\n          case 4:\n            mfaList = userData['UserMFASettingList'];\n            return [4\n            /*yield*/\n            , this._getMfaTypeFromUserData(userData)];\n\n          case 5:\n            currentMFAType = _b.sent();\n\n            if (currentMFAType === 'NOMFA') {\n              return [2\n              /*return*/\n              , Promise.resolve('No change for mfa type')];\n            } else if (currentMFAType === 'SMS_MFA') {\n              smsMfaSettings = {\n                PreferredMfa: false,\n                Enabled: false\n              };\n            } else if (currentMFAType === 'SOFTWARE_TOKEN_MFA') {\n              totpMfaSettings = {\n                PreferredMfa: false,\n                Enabled: false\n              };\n            } else {\n              return [2\n              /*return*/\n              , this.rejectAuthError(AuthErrorTypes.InvalidMFA)];\n            } // if there is a UserMFASettingList in the response\n            // we need to disable every mfa type in that list\n\n\n            if (mfaList && mfaList.length !== 0) {\n              // to disable SMS or TOTP if exists in that list\n              mfaList.forEach(function (mfaType) {\n                if (mfaType === 'SMS_MFA') {\n                  smsMfaSettings = {\n                    PreferredMfa: false,\n                    Enabled: false\n                  };\n                } else if (mfaType === 'SOFTWARE_TOKEN_MFA') {\n                  totpMfaSettings = {\n                    PreferredMfa: false,\n                    Enabled: false\n                  };\n                }\n              });\n            }\n\n            return [3\n            /*break*/\n            , 7];\n\n          case 6:\n            logger.debug('no validmfa method provided');\n            return [2\n            /*return*/\n            , this.rejectAuthError(AuthErrorTypes.NoMFA)];\n\n          case 7:\n            that = this;\n            return [2\n            /*return*/\n            , new Promise(function (res, rej) {\n              user.setUserMfaPreference(smsMfaSettings, totpMfaSettings, function (err, result) {\n                if (err) {\n                  logger.debug('Set user mfa preference error', err);\n                  return rej(err);\n                }\n\n                logger.debug('Set user mfa success', result);\n                logger.debug('Caching the latest user data into local'); // cache the latest result into user data\n\n                user.getUserData(function (err, data) {\n                  if (err) {\n                    logger.debug('getting user data failed', err);\n                    return rej(err);\n                  } else {\n                    return res(result);\n                  }\n                }, {\n                  bypassCache: true\n                });\n              });\n            })];\n        }\n      });\n    });\n  };\n  /**\n   * diable SMS\n   * @deprecated\n   * @param {CognitoUser} user - the current user\n   * @return - A promise resolves is success\n   */\n\n\n  AuthClass.prototype.disableSMS = function (user) {\n    return new Promise(function (res, rej) {\n      user.disableMFA(function (err, data) {\n        if (err) {\n          logger.debug('disable mfa failed', err);\n          rej(err);\n          return;\n        }\n\n        logger.debug('disable mfa succeed', data);\n        res(data);\n        return;\n      });\n    });\n  };\n  /**\n   * enable SMS\n   * @deprecated\n   * @param {CognitoUser} user - the current user\n   * @return - A promise resolves is success\n   */\n\n\n  AuthClass.prototype.enableSMS = function (user) {\n    return new Promise(function (res, rej) {\n      user.enableMFA(function (err, data) {\n        if (err) {\n          logger.debug('enable mfa failed', err);\n          rej(err);\n          return;\n        }\n\n        logger.debug('enable mfa succeed', data);\n        res(data);\n        return;\n      });\n    });\n  };\n  /**\n   * Setup TOTP\n   * @param {CognitoUser} user - the current user\n   * @return - A promise resolves with the secret code if success\n   */\n\n\n  AuthClass.prototype.setupTOTP = function (user) {\n    return new Promise(function (res, rej) {\n      user.associateSoftwareToken({\n        onFailure: function onFailure(err) {\n          logger.debug('associateSoftwareToken failed', err);\n          rej(err);\n          return;\n        },\n        associateSecretCode: function associateSecretCode(secretCode) {\n          logger.debug('associateSoftwareToken sucess', secretCode);\n          res(secretCode);\n          return;\n        }\n      });\n    });\n  };\n  /**\n   * verify TOTP setup\n   * @param {CognitoUser} user - the current user\n   * @param {string} challengeAnswer - challenge answer\n   * @return - A promise resolves is success\n   */\n\n\n  AuthClass.prototype.verifyTotpToken = function (user, challengeAnswer) {\n    logger.debug('verfication totp token', user, challengeAnswer);\n    return new Promise(function (res, rej) {\n      user.verifySoftwareToken(challengeAnswer, 'My TOTP device', {\n        onFailure: function onFailure(err) {\n          logger.debug('verifyTotpToken failed', err);\n          rej(err);\n          return;\n        },\n        onSuccess: function onSuccess(data) {\n          logger.debug('verifyTotpToken success', data);\n          res(data);\n          return;\n        }\n      });\n    });\n  };\n  /**\n   * Send MFA code to confirm sign in\n   * @param {Object} user - The CognitoUser object\n   * @param {String} code - The confirmation code\n   */\n\n\n  AuthClass.prototype.confirmSignIn = function (user, code, mfaType, clientMetadata) {\n    var _this = this;\n\n    if (clientMetadata === void 0) {\n      clientMetadata = this._config.clientMetadata;\n    }\n\n    if (!code) {\n      return this.rejectAuthError(AuthErrorTypes.EmptyCode);\n    }\n\n    var that = this;\n    return new Promise(function (resolve, reject) {\n      user.sendMFACode(code, {\n        onSuccess: function onSuccess(session) {\n          return __awaiter(_this, void 0, void 0, function () {\n            var cred, e_3;\n            return __generator(this, function (_a) {\n              switch (_a.label) {\n                case 0:\n                  logger.debug(session);\n                  _a.label = 1;\n\n                case 1:\n                  _a.trys.push([1, 4, 5, 6]);\n\n                  return [4\n                  /*yield*/\n                  , Credentials.clear()];\n\n                case 2:\n                  _a.sent();\n\n                  return [4\n                  /*yield*/\n                  , Credentials.set(session, 'session')];\n\n                case 3:\n                  cred = _a.sent();\n                  logger.debug('succeed to get cognito credentials', cred);\n                  return [3\n                  /*break*/\n                  , 6];\n\n                case 4:\n                  e_3 = _a.sent();\n                  logger.debug('cannot get cognito credentials', e_3);\n                  return [3\n                  /*break*/\n                  , 6];\n\n                case 5:\n                  that.user = user;\n                  dispatchAuthEvent('signIn', user, user + \" has signed in\");\n                  resolve(user);\n                  return [7\n                  /*endfinally*/\n                  ];\n\n                case 6:\n                  return [2\n                  /*return*/\n                  ];\n              }\n            });\n          });\n        },\n        onFailure: function onFailure(err) {\n          logger.debug('confirm signIn failure', err);\n          reject(err);\n        }\n      }, mfaType, clientMetadata);\n    });\n  };\n\n  AuthClass.prototype.completeNewPassword = function (user, password, requiredAttributes, clientMetadata) {\n    var _this = this;\n\n    if (clientMetadata === void 0) {\n      clientMetadata = this._config.clientMetadata;\n    }\n\n    if (!password) {\n      return this.rejectAuthError(AuthErrorTypes.EmptyPassword);\n    }\n\n    var that = this;\n    return new Promise(function (resolve, reject) {\n      user.completeNewPasswordChallenge(password, requiredAttributes, {\n        onSuccess: function onSuccess(session) {\n          return __awaiter(_this, void 0, void 0, function () {\n            var cred, e_4;\n            return __generator(this, function (_a) {\n              switch (_a.label) {\n                case 0:\n                  logger.debug(session);\n                  _a.label = 1;\n\n                case 1:\n                  _a.trys.push([1, 4, 5, 6]);\n\n                  return [4\n                  /*yield*/\n                  , Credentials.clear()];\n\n                case 2:\n                  _a.sent();\n\n                  return [4\n                  /*yield*/\n                  , Credentials.set(session, 'session')];\n\n                case 3:\n                  cred = _a.sent();\n                  logger.debug('succeed to get cognito credentials', cred);\n                  return [3\n                  /*break*/\n                  , 6];\n\n                case 4:\n                  e_4 = _a.sent();\n                  logger.debug('cannot get cognito credentials', e_4);\n                  return [3\n                  /*break*/\n                  , 6];\n\n                case 5:\n                  that.user = user;\n                  dispatchAuthEvent('signIn', user, user + \" has signed in\");\n                  resolve(user);\n                  return [7\n                  /*endfinally*/\n                  ];\n\n                case 6:\n                  return [2\n                  /*return*/\n                  ];\n              }\n            });\n          });\n        },\n        onFailure: function onFailure(err) {\n          logger.debug('completeNewPassword failure', err);\n          dispatchAuthEvent('completeNewPassword_failure', err, _this.user + \" failed to complete the new password flow\");\n          reject(err);\n        },\n        mfaRequired: function mfaRequired(challengeName, challengeParam) {\n          logger.debug('signIn MFA required');\n          user['challengeName'] = challengeName;\n          user['challengeParam'] = challengeParam;\n          resolve(user);\n        },\n        mfaSetup: function mfaSetup(challengeName, challengeParam) {\n          logger.debug('signIn mfa setup', challengeName);\n          user['challengeName'] = challengeName;\n          user['challengeParam'] = challengeParam;\n          resolve(user);\n        }\n      }, clientMetadata);\n    });\n  };\n  /**\n   * Send the answer to a custom challenge\n   * @param {CognitoUser} user - The CognitoUser object\n   * @param {String} challengeResponses - The confirmation code\n   */\n\n\n  AuthClass.prototype.sendCustomChallengeAnswer = function (user, challengeResponses, clientMetadata) {\n    var _this = this;\n\n    if (clientMetadata === void 0) {\n      clientMetadata = this._config.clientMetadata;\n    }\n\n    if (!this.userPool) {\n      return this.rejectNoUserPool();\n    }\n\n    if (!challengeResponses) {\n      return this.rejectAuthError(AuthErrorTypes.EmptyChallengeResponse);\n    }\n\n    var that = this;\n    return new Promise(function (resolve, reject) {\n      user.sendCustomChallengeAnswer(challengeResponses, _this.authCallbacks(user, resolve, reject), clientMetadata);\n    });\n  };\n  /**\n   * Update an authenticated users' attributes\n   * @param {CognitoUser} - The currently logged in user object\n   * @return {Promise}\n   **/\n\n\n  AuthClass.prototype.updateUserAttributes = function (user, attributes, clientMetadata) {\n    if (clientMetadata === void 0) {\n      clientMetadata = this._config.clientMetadata;\n    }\n\n    var attributeList = [];\n    var that = this;\n    return new Promise(function (resolve, reject) {\n      that.userSession(user).then(function (session) {\n        for (var key in attributes) {\n          if (key !== 'sub' && key.indexOf('_verified') < 0) {\n            var attr = {\n              Name: key,\n              Value: attributes[key]\n            };\n            attributeList.push(attr);\n          }\n        }\n\n        user.updateAttributes(attributeList, function (err, result) {\n          if (err) {\n            return reject(err);\n          } else {\n            return resolve(result);\n          }\n        }, clientMetadata);\n      });\n    });\n  };\n  /**\n   * Return user attributes\n   * @param {Object} user - The CognitoUser object\n   * @return - A promise resolves to user attributes if success\n   */\n\n\n  AuthClass.prototype.userAttributes = function (user) {\n    var _this = this;\n\n    return new Promise(function (resolve, reject) {\n      _this.userSession(user).then(function (session) {\n        user.getUserAttributes(function (err, attributes) {\n          if (err) {\n            reject(err);\n          } else {\n            resolve(attributes);\n          }\n        });\n      });\n    });\n  };\n\n  AuthClass.prototype.verifiedContact = function (user) {\n    var that = this;\n    return this.userAttributes(user).then(function (attributes) {\n      var attrs = that.attributesToObject(attributes);\n      var unverified = {};\n      var verified = {};\n\n      if (attrs['email']) {\n        if (attrs['email_verified']) {\n          verified['email'] = attrs['email'];\n        } else {\n          unverified['email'] = attrs['email'];\n        }\n      }\n\n      if (attrs['phone_number']) {\n        if (attrs['phone_number_verified']) {\n          verified['phone_number'] = attrs['phone_number'];\n        } else {\n          unverified['phone_number'] = attrs['phone_number'];\n        }\n      }\n\n      return {\n        verified: verified,\n        unverified: unverified\n      };\n    });\n  };\n  /**\n   * Get current authenticated user\n   * @return - A promise resolves to current authenticated CognitoUser if success\n   */\n\n\n  AuthClass.prototype.currentUserPoolUser = function (params) {\n    var _this = this;\n\n    if (!this.userPool) {\n      return this.rejectNoUserPool();\n    }\n\n    var that = this;\n    return new Promise(function (res, rej) {\n      _this._storageSync.then(function () {\n        var user = that.userPool.getCurrentUser();\n\n        if (!user) {\n          logger.debug('Failed to get user from user pool');\n          rej('No current user');\n          return;\n        } // refresh the session if the session expired.\n\n\n        user.getSession(function (err, session) {\n          if (err) {\n            logger.debug('Failed to get the user session', err);\n            rej(err);\n            return;\n          } // get user data from Cognito\n\n\n          var bypassCache = params ? params.bypassCache : false; // validate the token's scope fisrt before calling this function\n\n          var _a = session.getAccessToken().decodePayload().scope,\n              scope = _a === void 0 ? '' : _a;\n\n          if (scope.split(' ').includes(USER_ADMIN_SCOPE)) {\n            user.getUserData(function (err, data) {\n              if (err) {\n                logger.debug('getting user data failed', err); // Make sure the user is still valid\n\n                if (err.message === 'User is disabled' || err.message === 'User does not exist.') {\n                  rej(err);\n                } else {\n                  // the error may also be thrown when lack of permissions to get user info etc\n                  // in that case we just bypass the error\n                  res(user);\n                }\n\n                return;\n              }\n\n              var preferredMFA = data.PreferredMfaSetting || 'NOMFA';\n              var attributeList = [];\n\n              for (var i = 0; i < data.UserAttributes.length; i++) {\n                var attribute = {\n                  Name: data.UserAttributes[i].Name,\n                  Value: data.UserAttributes[i].Value\n                };\n                var userAttribute = new CognitoUserAttribute(attribute);\n                attributeList.push(userAttribute);\n              }\n\n              var attributes = that.attributesToObject(attributeList);\n              Object.assign(user, {\n                attributes: attributes,\n                preferredMFA: preferredMFA\n              });\n              return res(user);\n            }, {\n              bypassCache: bypassCache\n            });\n          } else {\n            logger.debug(\"Unable to get the user data because the \" + USER_ADMIN_SCOPE + \" \" + \"is not in the scopes of the access token\");\n            return res(user);\n          }\n        });\n      }).catch(function (e) {\n        logger.debug('Failed to sync cache info into memory', e);\n        return rej(e);\n      });\n    });\n  };\n  /**\n   * Get current authenticated user\n   * @param {CurrentUserOpts} - options for getting the current user\n   * @return - A promise resolves to current authenticated CognitoUser if success\n   */\n\n\n  AuthClass.prototype.currentAuthenticatedUser = function (params) {\n    return __awaiter(this, void 0, void 0, function () {\n      var federatedUser, e_5, user, e_6;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            logger.debug('getting current authenticated user');\n            federatedUser = null;\n            _a.label = 1;\n\n          case 1:\n            _a.trys.push([1, 3,, 4]);\n\n            return [4\n            /*yield*/\n            , this._storageSync];\n\n          case 2:\n            _a.sent();\n\n            return [3\n            /*break*/\n            , 4];\n\n          case 3:\n            e_5 = _a.sent();\n            logger.debug('Failed to sync cache info into memory', e_5);\n            throw e_5;\n\n          case 4:\n            try {\n              federatedUser = JSON.parse(this._storage.getItem('aws-amplify-federatedInfo')).user;\n            } catch (e) {\n              logger.debug('cannot load federated user from auth storage');\n            }\n\n            if (!federatedUser) return [3\n            /*break*/\n            , 5];\n            this.user = federatedUser;\n            logger.debug('get current authenticated federated user', this.user);\n            return [2\n            /*return*/\n            , this.user];\n\n          case 5:\n            logger.debug('get current authenticated userpool user');\n            user = null;\n            _a.label = 6;\n\n          case 6:\n            _a.trys.push([6, 8,, 9]);\n\n            return [4\n            /*yield*/\n            , this.currentUserPoolUser(params)];\n\n          case 7:\n            user = _a.sent();\n            return [3\n            /*break*/\n            , 9];\n\n          case 8:\n            e_6 = _a.sent();\n\n            if (e_6 === 'No userPool') {\n              logger.error('Cannot get the current user because the user pool is missing. ' + 'Please make sure the Auth module is configured with a valid Cognito User Pool ID');\n            }\n\n            logger.debug('The user is not authenticated by the error', e_6);\n            throw 'not authenticated';\n\n          case 9:\n            this.user = user;\n            return [2\n            /*return*/\n            , this.user];\n        }\n      });\n    });\n  };\n  /**\n   * Get current user's session\n   * @return - A promise resolves to session object if success\n   */\n\n\n  AuthClass.prototype.currentSession = function () {\n    var that = this;\n    logger.debug('Getting current session'); // Purposely not calling the reject method here because we don't need a console error\n\n    if (!this.userPool) {\n      return Promise.reject();\n    }\n\n    return new Promise(function (res, rej) {\n      that.currentUserPoolUser().then(function (user) {\n        that.userSession(user).then(function (session) {\n          res(session);\n          return;\n        }).catch(function (e) {\n          logger.debug('Failed to get the current session', e);\n          rej(e);\n          return;\n        });\n      }).catch(function (e) {\n        logger.debug('Failed to get the current user', e);\n        rej(e);\n        return;\n      });\n    });\n  };\n  /**\n   * Get the corresponding user session\n   * @param {Object} user - The CognitoUser object\n   * @return - A promise resolves to the session\n   */\n\n\n  AuthClass.prototype.userSession = function (user) {\n    if (!user) {\n      logger.debug('the user is null');\n      return this.rejectAuthError(AuthErrorTypes.NoUserSession);\n    }\n\n    return new Promise(function (resolve, reject) {\n      logger.debug('Getting the session from this user:', user);\n      user.getSession(function (err, session) {\n        if (err) {\n          logger.debug('Failed to get the session from user', user);\n          reject(err);\n          return;\n        } else {\n          logger.debug('Succeed to get the user session', session);\n          resolve(session);\n          return;\n        }\n      });\n    });\n  };\n  /**\n   * Get  authenticated credentials of current user.\n   * @return - A promise resolves to be current user's credentials\n   */\n\n\n  AuthClass.prototype.currentUserCredentials = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      var that, e_7, federatedInfo;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            that = this;\n            logger.debug('Getting current user credentials');\n            _a.label = 1;\n\n          case 1:\n            _a.trys.push([1, 3,, 4]);\n\n            return [4\n            /*yield*/\n            , this._storageSync];\n\n          case 2:\n            _a.sent();\n\n            return [3\n            /*break*/\n            , 4];\n\n          case 3:\n            e_7 = _a.sent();\n            logger.debug('Failed to sync cache info into memory', e_7);\n            throw e_7;\n\n          case 4:\n            federatedInfo = null;\n\n            try {\n              federatedInfo = JSON.parse(this._storage.getItem('aws-amplify-federatedInfo'));\n            } catch (e) {\n              logger.debug('failed to get or parse item aws-amplify-federatedInfo', e);\n            }\n\n            if (federatedInfo) {\n              // refresh the jwt token here if necessary\n              return [2\n              /*return*/\n              , Credentials.refreshFederatedToken(federatedInfo)];\n            } else {\n              return [2\n              /*return*/\n              , this.currentSession().then(function (session) {\n                logger.debug('getting session success', session);\n                return Credentials.set(session, 'session');\n              }).catch(function (error) {\n                logger.debug('getting session failed', error);\n                return Credentials.set(null, 'guest');\n              })];\n            }\n\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  AuthClass.prototype.currentCredentials = function () {\n    logger.debug('getting current credntials');\n    return Credentials.get();\n  };\n  /**\n   * Initiate an attribute confirmation request\n   * @param {Object} user - The CognitoUser\n   * @param {Object} attr - The attributes to be verified\n   * @return - A promise resolves to callback data if success\n   */\n\n\n  AuthClass.prototype.verifyUserAttribute = function (user, attr, clientMetadata) {\n    if (clientMetadata === void 0) {\n      clientMetadata = this._config.clientMetadata;\n    }\n\n    return new Promise(function (resolve, reject) {\n      user.getAttributeVerificationCode(attr, {\n        onSuccess: function onSuccess() {\n          return resolve();\n        },\n        onFailure: function onFailure(err) {\n          return reject(err);\n        },\n        clientMetadata: clientMetadata\n      });\n    });\n  };\n  /**\n   * Confirm an attribute using a confirmation code\n   * @param {Object} user - The CognitoUser\n   * @param {Object} attr - The attribute to be verified\n   * @param {String} code - The confirmation code\n   * @return - A promise resolves to callback data if success\n   */\n\n\n  AuthClass.prototype.verifyUserAttributeSubmit = function (user, attr, code) {\n    if (!code) {\n      return this.rejectAuthError(AuthErrorTypes.EmptyCode);\n    }\n\n    return new Promise(function (resolve, reject) {\n      user.verifyAttribute(attr, code, {\n        onSuccess: function onSuccess(data) {\n          resolve(data);\n          return;\n        },\n        onFailure: function onFailure(err) {\n          reject(err);\n          return;\n        }\n      });\n    });\n  };\n\n  AuthClass.prototype.verifyCurrentUserAttribute = function (attr) {\n    var that = this;\n    return that.currentUserPoolUser().then(function (user) {\n      return that.verifyUserAttribute(user, attr);\n    });\n  };\n  /**\n   * Confirm current user's attribute using a confirmation code\n   * @param {Object} attr - The attribute to be verified\n   * @param {String} code - The confirmation code\n   * @return - A promise resolves to callback data if success\n   */\n\n\n  AuthClass.prototype.verifyCurrentUserAttributeSubmit = function (attr, code) {\n    var that = this;\n    return that.currentUserPoolUser().then(function (user) {\n      return that.verifyUserAttributeSubmit(user, attr, code);\n    });\n  };\n\n  AuthClass.prototype.cognitoIdentitySignOut = function (opts, user) {\n    return __awaiter(this, void 0, void 0, function () {\n      var e_8, isSignedInHostedUI;\n\n      var _this = this;\n\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            _a.trys.push([0, 2,, 3]);\n\n            return [4\n            /*yield*/\n            , this._storageSync];\n\n          case 1:\n            _a.sent();\n\n            return [3\n            /*break*/\n            , 3];\n\n          case 2:\n            e_8 = _a.sent();\n            logger.debug('Failed to sync cache info into memory', e_8);\n            throw e_8;\n\n          case 3:\n            isSignedInHostedUI = this._oAuthHandler && this._storage.getItem('amplify-signin-with-hostedUI') === 'true';\n            return [2\n            /*return*/\n            , new Promise(function (res, rej) {\n              if (opts && opts.global) {\n                logger.debug('user global sign out', user); // in order to use global signout\n                // we must validate the user as an authenticated user by using getSession\n\n                user.getSession(function (err, result) {\n                  if (err) {\n                    logger.debug('failed to get the user session', err);\n                    return rej(err);\n                  }\n\n                  user.globalSignOut({\n                    onSuccess: function onSuccess(data) {\n                      logger.debug('global sign out success');\n\n                      if (isSignedInHostedUI) {\n                        return res(_this._oAuthHandler.signOut());\n                      } else {\n                        return res();\n                      }\n                    },\n                    onFailure: function onFailure(err) {\n                      logger.debug('global sign out failed', err);\n                      return rej(err);\n                    }\n                  });\n                });\n              } else {\n                logger.debug('user sign out', user);\n                user.signOut();\n\n                if (isSignedInHostedUI) {\n                  return res(_this._oAuthHandler.signOut());\n                } else {\n                  return res();\n                }\n              }\n            })];\n        }\n      });\n    });\n  };\n  /**\n   * Sign out method\n   * @\n   * @return - A promise resolved if success\n   */\n\n\n  AuthClass.prototype.signOut = function (opts) {\n    return __awaiter(this, void 0, void 0, function () {\n      var e_9, user;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            _a.trys.push([0, 2,, 3]);\n\n            return [4\n            /*yield*/\n            , this.cleanCachedItems()];\n\n          case 1:\n            _a.sent();\n\n            return [3\n            /*break*/\n            , 3];\n\n          case 2:\n            e_9 = _a.sent();\n            logger.debug('failed to clear cached items');\n            return [3\n            /*break*/\n            , 3];\n\n          case 3:\n            if (!this.userPool) return [3\n            /*break*/\n            , 7];\n            user = this.userPool.getCurrentUser();\n            if (!user) return [3\n            /*break*/\n            , 5];\n            return [4\n            /*yield*/\n            , this.cognitoIdentitySignOut(opts, user)];\n\n          case 4:\n            _a.sent();\n\n            return [3\n            /*break*/\n            , 6];\n\n          case 5:\n            logger.debug('no current Cognito user');\n            _a.label = 6;\n\n          case 6:\n            return [3\n            /*break*/\n            , 8];\n\n          case 7:\n            logger.debug('no Congito User pool');\n            _a.label = 8;\n\n          case 8:\n            /**\n             * Note for future refactor - no reliable way to get username with\n             * Cognito User Pools vs Identity when federating with Social Providers\n             * This is why we need a well structured session object that can be inspected\n             * and information passed back in the message below for Hub dispatch\n             */\n            dispatchAuthEvent('signOut', this.user, \"A user has been signed out\");\n            this.user = null;\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  AuthClass.prototype.cleanCachedItems = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            // clear cognito cached item\n            return [4\n            /*yield*/\n            , Credentials.clear()];\n\n          case 1:\n            // clear cognito cached item\n            _a.sent();\n\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n  /**\n   * Change a password for an authenticated user\n   * @param {Object} user - The CognitoUser object\n   * @param {String} oldPassword - the current password\n   * @param {String} newPassword - the requested new password\n   * @return - A promise resolves if success\n   */\n\n\n  AuthClass.prototype.changePassword = function (user, oldPassword, newPassword, clientMetadata) {\n    var _this = this;\n\n    if (clientMetadata === void 0) {\n      clientMetadata = this._config.clientMetadata;\n    }\n\n    return new Promise(function (resolve, reject) {\n      _this.userSession(user).then(function (session) {\n        user.changePassword(oldPassword, newPassword, function (err, data) {\n          if (err) {\n            logger.debug('change password failure', err);\n            return reject(err);\n          } else {\n            return resolve(data);\n          }\n        }, clientMetadata);\n      });\n    });\n  };\n  /**\n   * Initiate a forgot password request\n   * @param {String} username - the username to change password\n   * @return - A promise resolves if success\n   */\n\n\n  AuthClass.prototype.forgotPassword = function (username, clientMetadata) {\n    if (clientMetadata === void 0) {\n      clientMetadata = this._config.clientMetadata;\n    }\n\n    if (!this.userPool) {\n      return this.rejectNoUserPool();\n    }\n\n    if (!username) {\n      return this.rejectAuthError(AuthErrorTypes.EmptyUsername);\n    }\n\n    var user = this.createCognitoUser(username);\n    return new Promise(function (resolve, reject) {\n      user.forgotPassword({\n        onSuccess: function onSuccess() {\n          resolve();\n          return;\n        },\n        onFailure: function onFailure(err) {\n          logger.debug('forgot password failure', err);\n          dispatchAuthEvent('forgotPassword_failure', err, username + \" forgotPassword failed\");\n          reject(err);\n          return;\n        },\n        inputVerificationCode: function inputVerificationCode(data) {\n          dispatchAuthEvent('forgotPassword', user, username + \" has initiated forgot password flow\");\n          resolve(data);\n          return;\n        }\n      }, clientMetadata);\n    });\n  };\n  /**\n   * Confirm a new password using a confirmation Code\n   * @param {String} username - The username\n   * @param {String} code - The confirmation code\n   * @param {String} password - The new password\n   * @return - A promise that resolves if success\n   */\n\n\n  AuthClass.prototype.forgotPasswordSubmit = function (username, code, password, clientMetadata) {\n    if (clientMetadata === void 0) {\n      clientMetadata = this._config.clientMetadata;\n    }\n\n    if (!this.userPool) {\n      return this.rejectNoUserPool();\n    }\n\n    if (!username) {\n      return this.rejectAuthError(AuthErrorTypes.EmptyUsername);\n    }\n\n    if (!code) {\n      return this.rejectAuthError(AuthErrorTypes.EmptyCode);\n    }\n\n    if (!password) {\n      return this.rejectAuthError(AuthErrorTypes.EmptyPassword);\n    }\n\n    var user = this.createCognitoUser(username);\n    return new Promise(function (resolve, reject) {\n      user.confirmPassword(code, password, {\n        onSuccess: function onSuccess() {\n          dispatchAuthEvent('forgotPasswordSubmit', user, username + \" forgotPasswordSubmit successful\");\n          resolve();\n          return;\n        },\n        onFailure: function onFailure(err) {\n          dispatchAuthEvent('forgotPasswordSubmit_failure', err, username + \" forgotPasswordSubmit failed\");\n          reject(err);\n          return;\n        }\n      }, clientMetadata);\n    });\n  };\n  /**\n   * Get user information\n   * @async\n   * @return {Object }- current User's information\n   */\n\n\n  AuthClass.prototype.currentUserInfo = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      var source, user, attributes, userAttrs, credentials, e_10, info, err_1, user;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            source = Credentials.getCredSource();\n            if (!(!source || source === 'aws' || source === 'userPool')) return [3\n            /*break*/\n            , 9];\n            return [4\n            /*yield*/\n            , this.currentUserPoolUser().catch(function (err) {\n              return logger.debug(err);\n            })];\n\n          case 1:\n            user = _a.sent();\n\n            if (!user) {\n              return [2\n              /*return*/\n              , null];\n            }\n\n            _a.label = 2;\n\n          case 2:\n            _a.trys.push([2, 8,, 9]);\n\n            return [4\n            /*yield*/\n            , this.userAttributes(user)];\n\n          case 3:\n            attributes = _a.sent();\n            userAttrs = this.attributesToObject(attributes);\n            credentials = null;\n            _a.label = 4;\n\n          case 4:\n            _a.trys.push([4, 6,, 7]);\n\n            return [4\n            /*yield*/\n            , this.currentCredentials()];\n\n          case 5:\n            credentials = _a.sent();\n            return [3\n            /*break*/\n            , 7];\n\n          case 6:\n            e_10 = _a.sent();\n            logger.debug('Failed to retrieve credentials while getting current user info', e_10);\n            return [3\n            /*break*/\n            , 7];\n\n          case 7:\n            info = {\n              id: credentials ? credentials.identityId : undefined,\n              username: user.getUsername(),\n              attributes: userAttrs\n            };\n            return [2\n            /*return*/\n            , info];\n\n          case 8:\n            err_1 = _a.sent();\n            logger.debug('currentUserInfo error', err_1);\n            return [2\n            /*return*/\n            , {}];\n\n          case 9:\n            if (source === 'federated') {\n              user = this.user;\n              return [2\n              /*return*/\n              , user ? user : {}];\n            }\n\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  AuthClass.prototype.federatedSignIn = function (providerOrOptions, response, user) {\n    return __awaiter(this, void 0, void 0, function () {\n      var options, provider, customState, client_id, redirect_uri, provider, loggedInUser, token, identity_id, expires_at, credentials, currentUser;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            if (!this._config.identityPoolId && !this._config.userPoolId) {\n              throw new Error(\"Federation requires either a User Pool or Identity Pool in config\");\n            } // Ensure backwards compatability\n\n\n            if (typeof providerOrOptions === 'undefined') {\n              if (this._config.identityPoolId && !this._config.userPoolId) {\n                throw new Error(\"Federation with Identity Pools requires tokens passed as arguments\");\n              }\n            }\n\n            if (!(isFederatedSignInOptions(providerOrOptions) || isFederatedSignInOptionsCustom(providerOrOptions) || typeof providerOrOptions === 'undefined')) return [3\n            /*break*/\n            , 1];\n            options = providerOrOptions || {\n              provider: CognitoHostedUIIdentityProvider.Cognito\n            };\n            provider = isFederatedSignInOptions(options) ? options.provider : options.customProvider;\n            customState = isFederatedSignInOptions(options) ? options.customState : options.customState;\n\n            if (this._config.userPoolId) {\n              client_id = isCognitoHostedOpts(this._config.oauth) ? this._config.userPoolWebClientId : this._config.oauth.clientID;\n              redirect_uri = isCognitoHostedOpts(this._config.oauth) ? this._config.oauth.redirectSignIn : this._config.oauth.redirectUri;\n\n              this._oAuthHandler.oauthSignIn(this._config.oauth.responseType, this._config.oauth.domain, redirect_uri, client_id, provider, customState);\n            }\n\n            return [3\n            /*break*/\n            , 4];\n\n          case 1:\n            provider = providerOrOptions; // To check if the user is already logged in\n\n            try {\n              loggedInUser = JSON.stringify(JSON.parse(this._storage.getItem('aws-amplify-federatedInfo')).user);\n\n              if (loggedInUser) {\n                logger.warn(\"There is already a signed in user: \" + loggedInUser + \" in your app.\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tYou should not call Auth.federatedSignIn method again as it may cause unexpected behavior.\");\n              }\n            } catch (e) {}\n\n            token = response.token, identity_id = response.identity_id, expires_at = response.expires_at;\n            return [4\n            /*yield*/\n            , Credentials.set({\n              provider: provider,\n              token: token,\n              identity_id: identity_id,\n              user: user,\n              expires_at: expires_at\n            }, 'federation')];\n\n          case 2:\n            credentials = _a.sent();\n            return [4\n            /*yield*/\n            , this.currentAuthenticatedUser()];\n\n          case 3:\n            currentUser = _a.sent();\n            dispatchAuthEvent('signIn', currentUser, \"A user \" + currentUser.username + \" has been signed in\");\n            logger.debug('federated sign in credentials', credentials);\n            return [2\n            /*return*/\n            , credentials];\n\n          case 4:\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n  /**\n   * Used to complete the OAuth flow with or without the Cognito Hosted UI\n   * @param {String} URL - optional parameter for customers to pass in the response URL\n   */\n\n\n  AuthClass.prototype._handleAuthResponse = function (URL) {\n    return __awaiter(this, void 0, void 0, function () {\n      var currentUrl, hasCodeOrError, hasTokenOrError, _a, accessToken, idToken, refreshToken, state, session, credentials, isCustomStateIncluded, currentUser, _b, customState, err_2;\n\n      return __generator(this, function (_c) {\n        switch (_c.label) {\n          case 0:\n            if (!this._config.userPoolId) {\n              throw new Error(\"OAuth responses require a User Pool defined in config\");\n            }\n\n            dispatchAuthEvent('parsingCallbackUrl', {\n              url: URL\n            }, \"The callback url is being parsed\");\n            currentUrl = URL || (JS.browserOrNode().isBrowser ? window.location.href : '');\n            hasCodeOrError = !!(parse(currentUrl).query || '').split('&').map(function (entry) {\n              return entry.split('=');\n            }).find(function (_a) {\n              var k = _a[0];\n              return k === 'code' || k === 'error';\n            });\n            hasTokenOrError = !!(parse(currentUrl).hash || '#').substr(1).split('&').map(function (entry) {\n              return entry.split('=');\n            }).find(function (_a) {\n              var k = _a[0];\n              return k === 'access_token' || k === 'error';\n            });\n            if (!(hasCodeOrError || hasTokenOrError)) return [3\n            /*break*/\n            , 6];\n            _c.label = 1;\n\n          case 1:\n            _c.trys.push([1, 5,, 6]);\n\n            return [4\n            /*yield*/\n            , this._oAuthHandler.handleAuthResponse(currentUrl)];\n\n          case 2:\n            _a = _c.sent(), accessToken = _a.accessToken, idToken = _a.idToken, refreshToken = _a.refreshToken, state = _a.state;\n            session = new CognitoUserSession({\n              IdToken: new CognitoIdToken({\n                IdToken: idToken\n              }),\n              RefreshToken: new CognitoRefreshToken({\n                RefreshToken: refreshToken\n              }),\n              AccessToken: new CognitoAccessToken({\n                AccessToken: accessToken\n              })\n            });\n            credentials = void 0;\n            if (!this._config.identityPoolId) return [3\n            /*break*/\n            , 4];\n            return [4\n            /*yield*/\n            , Credentials.set(session, 'session')];\n\n          case 3:\n            credentials = _c.sent();\n            logger.debug('AWS credentials', credentials);\n            _c.label = 4;\n\n          case 4:\n            isCustomStateIncluded = /-/.test(state);\n            currentUser = this.createCognitoUser(session.getIdToken().decodePayload()['cognito:username']);\n            dispatchAuthEvent('signIn', currentUser, \"A user \" + currentUser.getUsername() + \" has been signed in\");\n            dispatchAuthEvent('cognitoHostedUI', currentUser, \"A user \" + currentUser.getUsername() + \" has been signed in via Cognito Hosted UI\");\n\n            if (isCustomStateIncluded) {\n              _b = state.split('-'), customState = _b[1];\n              dispatchAuthEvent('customOAuthState', customState, \"State for user \" + currentUser.getUsername());\n            } // This calls cacheTokens() in Cognito SDK\n\n\n            currentUser.setSignInUserSession(session); //#endregion\n\n            if (window && typeof window.history !== 'undefined') {\n              window.history.replaceState({}, null, this._config.oauth.redirectSignIn);\n            }\n\n            return [2\n            /*return*/\n            , credentials];\n\n          case 5:\n            err_2 = _c.sent();\n            logger.debug('Error in cognito hosted auth response', err_2);\n            dispatchAuthEvent('signIn_failure', err_2, \"The OAuth response flow failed\");\n            dispatchAuthEvent('cognitoHostedUI_failure', err_2, \"A failure occurred when returning to the Cognito Hosted UI\");\n            dispatchAuthEvent('customState_failure', err_2, \"A failure occurred when returning state\");\n            throw err_2;\n\n          case 6:\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n  /**\n   * Compact version of credentials\n   * @param {Object} credentials\n   * @return {Object} - Credentials\n   */\n\n\n  AuthClass.prototype.essentialCredentials = function (credentials) {\n    return {\n      accessKeyId: credentials.accessKeyId,\n      sessionToken: credentials.sessionToken,\n      secretAccessKey: credentials.secretAccessKey,\n      identityId: credentials.identityId,\n      authenticated: credentials.authenticated\n    };\n  };\n\n  AuthClass.prototype.attributesToObject = function (attributes) {\n    var obj = {};\n\n    if (attributes) {\n      attributes.map(function (attribute) {\n        if (attribute.Value === 'true') {\n          obj[attribute.Name] = true;\n        } else if (attribute.Value === 'false') {\n          obj[attribute.Name] = false;\n        } else {\n          obj[attribute.Name] = attribute.Value;\n        }\n      });\n    }\n\n    return obj;\n  };\n\n  AuthClass.prototype.createCognitoUser = function (username) {\n    var userData = {\n      Username: username,\n      Pool: this.userPool\n    };\n    userData.Storage = this._storage;\n    var authenticationFlowType = this._config.authenticationFlowType;\n    var user = new CognitoUser(userData);\n\n    if (authenticationFlowType) {\n      user.setAuthenticationFlowType(authenticationFlowType);\n    }\n\n    return user;\n  };\n\n  AuthClass.prototype._isValidAuthStorage = function (obj) {\n    // We need to check if the obj has the functions of Storage\n    return !!obj && typeof obj.getItem === 'function' && typeof obj.setItem === 'function' && typeof obj.removeItem === 'function' && typeof obj.clear === 'function';\n  };\n\n  AuthClass.prototype.noUserPoolErrorHandler = function (config) {\n    if (config) {\n      if (!config.userPoolId || !config.identityPoolId) {\n        return AuthErrorTypes.MissingAuthConfig;\n      }\n    }\n\n    return AuthErrorTypes.NoConfig;\n  };\n\n  AuthClass.prototype.rejectAuthError = function (type) {\n    return Promise.reject(new AuthError(type));\n  };\n\n  AuthClass.prototype.rejectNoUserPool = function () {\n    var type = this.noUserPoolErrorHandler(this._config);\n    return Promise.reject(new NoUserPoolError(type));\n  };\n\n  return AuthClass;\n}();\n\nexport default AuthClass;","map":{"version":3,"sources":["../src/Auth.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["/*\n * Copyright 2017-2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"). You may not use this file except in compliance with\n * the License. A copy of the License is located at\n *\n *     http://aws.amazon.com/apache2.0/\n *\n * or in the \"license\" file accompanying this file. This file is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR\n * CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions\n * and limitations under the License.\n */\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (this && this.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\nimport { isUsernamePasswordOpts, isCognitoHostedOpts, isFederatedSignInOptions, isFederatedSignInOptionsCustom, } from './types';\nimport { AWS, ConsoleLogger as Logger, Constants, Hub, JS, Parser, Credentials, StorageHelper, } from '@aws-amplify/core';\nimport { CookieStorage, CognitoUserPool, AuthenticationDetails, CognitoUser, CognitoUserSession, CognitoUserAttribute, CognitoIdToken, CognitoRefreshToken, CognitoAccessToken, } from 'amazon-cognito-identity-js';\nimport { parse } from 'url';\nimport OAuth from './OAuth/OAuth';\nimport { default as urlListener } from './urlListener';\nimport { AuthError, NoUserPoolError } from './Errors';\nimport { AuthErrorTypes } from './types/Auth';\nvar logger = new Logger('AuthClass');\nvar USER_ADMIN_SCOPE = 'aws.cognito.signin.user.admin';\nvar AMPLIFY_SYMBOL = (typeof Symbol !== 'undefined' &&\n    typeof Symbol.for === 'function'\n    ? Symbol.for('amplify_default')\n    : '@@amplify_default');\nvar dispatchAuthEvent = function (event, data, message) {\n    Hub.dispatch('auth', { event: event, data: data, message: message }, 'Auth', AMPLIFY_SYMBOL);\n};\nexport var CognitoHostedUIIdentityProvider;\n(function (CognitoHostedUIIdentityProvider) {\n    CognitoHostedUIIdentityProvider[\"Cognito\"] = \"COGNITO\";\n    CognitoHostedUIIdentityProvider[\"Google\"] = \"Google\";\n    CognitoHostedUIIdentityProvider[\"Facebook\"] = \"Facebook\";\n    CognitoHostedUIIdentityProvider[\"Amazon\"] = \"LoginWithAmazon\";\n})(CognitoHostedUIIdentityProvider || (CognitoHostedUIIdentityProvider = {}));\n/**\n * Provide authentication steps\n */\nvar AuthClass = /** @class */ (function () {\n    /**\n     * Initialize Auth with AWS configurations\n     * @param {Object} config - Configuration of the Auth\n     */\n    function AuthClass(config) {\n        var _this = this;\n        this.userPool = null;\n        this.user = null;\n        this.configure(config);\n        this.currentUserCredentials = this.currentUserCredentials.bind(this);\n        if (AWS.config) {\n            AWS.config.update({ customUserAgent: Constants.userAgent });\n        }\n        else {\n            logger.warn('No AWS.config');\n        }\n        Hub.listen('auth', function (_a) {\n            var payload = _a.payload;\n            var event = payload.event;\n            switch (event) {\n                case 'signIn':\n                    _this._storage.setItem('amplify-signin-with-hostedUI', 'false');\n                    break;\n                case 'signOut':\n                    _this._storage.removeItem('amplify-signin-with-hostedUI');\n                    break;\n                case 'cognitoHostedUI':\n                    _this._storage.setItem('amplify-signin-with-hostedUI', 'true');\n                    break;\n            }\n        });\n    }\n    AuthClass.prototype.getModuleName = function () {\n        return 'Auth';\n    };\n    AuthClass.prototype.configure = function (config) {\n        var _this = this;\n        if (!config)\n            return this._config || {};\n        logger.debug('configure Auth');\n        var conf = Object.assign({}, this._config, Parser.parseMobilehubConfig(config).Auth, config);\n        this._config = conf;\n        var _a = this._config, userPoolId = _a.userPoolId, userPoolWebClientId = _a.userPoolWebClientId, cookieStorage = _a.cookieStorage, oauth = _a.oauth, region = _a.region, identityPoolId = _a.identityPoolId, mandatorySignIn = _a.mandatorySignIn, refreshHandlers = _a.refreshHandlers, identityPoolRegion = _a.identityPoolRegion, clientMetadata = _a.clientMetadata;\n        if (!this._config.storage) {\n            // backward compatbility\n            if (cookieStorage)\n                this._storage = new CookieStorage(cookieStorage);\n            else {\n                this._storage = new StorageHelper().getStorage();\n            }\n        }\n        else {\n            if (!this._isValidAuthStorage(this._config.storage)) {\n                logger.error('The storage in the Auth config is not valid!');\n                throw new Error('Empty storage object');\n            }\n            this._storage = this._config.storage;\n        }\n        this._storageSync = Promise.resolve();\n        if (typeof this._storage['sync'] === 'function') {\n            this._storageSync = this._storage['sync']();\n        }\n        if (userPoolId) {\n            var userPoolData = {\n                UserPoolId: userPoolId,\n                ClientId: userPoolWebClientId,\n            };\n            userPoolData.Storage = this._storage;\n            this.userPool = new CognitoUserPool(userPoolData);\n        }\n        Credentials.configure({\n            mandatorySignIn: mandatorySignIn,\n            region: identityPoolRegion || region,\n            userPoolId: userPoolId,\n            identityPoolId: identityPoolId,\n            refreshHandlers: refreshHandlers,\n            storage: this._storage,\n        });\n        // initiailize cognitoauth client if hosted ui options provided\n        // to keep backward compatibility:\n        var cognitoHostedUIConfig = oauth\n            ? isCognitoHostedOpts(this._config.oauth)\n                ? oauth\n                : oauth.awsCognito\n            : undefined;\n        if (cognitoHostedUIConfig) {\n            var cognitoAuthParams = Object.assign({\n                cognitoClientId: userPoolWebClientId,\n                UserPoolId: userPoolId,\n                domain: cognitoHostedUIConfig['domain'],\n                scopes: cognitoHostedUIConfig['scope'],\n                redirectSignIn: cognitoHostedUIConfig['redirectSignIn'],\n                redirectSignOut: cognitoHostedUIConfig['redirectSignOut'],\n                responseType: cognitoHostedUIConfig['responseType'],\n                Storage: this._storage,\n                urlOpener: cognitoHostedUIConfig['urlOpener'],\n                clientMetadata: clientMetadata,\n            }, cognitoHostedUIConfig['options']);\n            this._oAuthHandler = new OAuth({\n                scopes: cognitoAuthParams.scopes,\n                config: cognitoAuthParams,\n                cognitoClientId: cognitoAuthParams.cognitoClientId,\n            });\n            // **NOTE** - Remove this in a future major release as it is a breaking change\n            urlListener(function (_a) {\n                var url = _a.url;\n                _this._handleAuthResponse(url);\n            });\n        }\n        dispatchAuthEvent('configured', null, \"The Auth category has been configured successfully\");\n        return this._config;\n    };\n    /**\n     * Sign up with username, password and other attrbutes like phone, email\n     * @param {String | object} params - The user attirbutes used for signin\n     * @param {String[]} restOfAttrs - for the backward compatability\n     * @return - A promise resolves callback data if success\n     */\n    AuthClass.prototype.signUp = function (params) {\n        var _this = this;\n        var restOfAttrs = [];\n        for (var _i = 1; _i < arguments.length; _i++) {\n            restOfAttrs[_i - 1] = arguments[_i];\n        }\n        if (!this.userPool) {\n            return this.rejectNoUserPool();\n        }\n        var username = null;\n        var password = null;\n        var attributes = [];\n        var validationData = null;\n        var clientMetadata;\n        if (params && typeof params === 'string') {\n            username = params;\n            password = restOfAttrs ? restOfAttrs[0] : null;\n            var email = restOfAttrs ? restOfAttrs[1] : null;\n            var phone_number = restOfAttrs ? restOfAttrs[2] : null;\n            if (email)\n                attributes.push({ Name: 'email', Value: email });\n            if (phone_number)\n                attributes.push({ Name: 'phone_number', Value: phone_number });\n        }\n        else if (params && typeof params === 'object') {\n            username = params['username'];\n            password = params['password'];\n            if (params && params.clientMetadata) {\n                clientMetadata = params.clientMetadata;\n            }\n            else if (this._config.clientMetadata) {\n                clientMetadata = this._config.clientMetadata;\n            }\n            var attrs_1 = params['attributes'];\n            if (attrs_1) {\n                Object.keys(attrs_1).map(function (key) {\n                    var ele = { Name: key, Value: attrs_1[key] };\n                    attributes.push(ele);\n                });\n            }\n            validationData = params['validationData'] || null;\n        }\n        else {\n            return this.rejectAuthError(AuthErrorTypes.SignUpError);\n        }\n        if (!username) {\n            return this.rejectAuthError(AuthErrorTypes.EmptyUsername);\n        }\n        if (!password) {\n            return this.rejectAuthError(AuthErrorTypes.EmptyPassword);\n        }\n        logger.debug('signUp attrs:', attributes);\n        logger.debug('signUp validation data:', validationData);\n        return new Promise(function (resolve, reject) {\n            _this.userPool.signUp(username, password, attributes, validationData, function (err, data) {\n                if (err) {\n                    dispatchAuthEvent('signUp_failure', err, username + \" failed to signup\");\n                    reject(err);\n                }\n                else {\n                    dispatchAuthEvent('signUp', data, username + \" has signed up successfully\");\n                    resolve(data);\n                }\n            }, clientMetadata);\n        });\n    };\n    /**\n     * Send the verfication code to confirm sign up\n     * @param {String} username - The username to be confirmed\n     * @param {String} code - The verification code\n     * @param {ConfirmSignUpOptions} options - other options for confirm signup\n     * @return - A promise resolves callback data if success\n     */\n    AuthClass.prototype.confirmSignUp = function (username, code, options) {\n        if (!this.userPool) {\n            return this.rejectNoUserPool();\n        }\n        if (!username) {\n            return this.rejectAuthError(AuthErrorTypes.EmptyUsername);\n        }\n        if (!code) {\n            return this.rejectAuthError(AuthErrorTypes.EmptyCode);\n        }\n        var user = this.createCognitoUser(username);\n        var forceAliasCreation = options && typeof options.forceAliasCreation === 'boolean'\n            ? options.forceAliasCreation\n            : true;\n        var clientMetadata;\n        if (options && options.clientMetadata) {\n            clientMetadata = options.clientMetadata;\n        }\n        else if (this._config.clientMetadata) {\n            clientMetadata = this._config.clientMetadata;\n        }\n        return new Promise(function (resolve, reject) {\n            user.confirmRegistration(code, forceAliasCreation, function (err, data) {\n                if (err) {\n                    reject(err);\n                }\n                else {\n                    resolve(data);\n                }\n            }, clientMetadata);\n        });\n    };\n    /**\n     * Resend the verification code\n     * @param {String} username - The username to be confirmed\n     * @param {ClientMetadata} clientMetadata - Metadata to be passed to Cognito Lambda triggers\n     * @return - A promise resolves data if success\n     */\n    AuthClass.prototype.resendSignUp = function (username, clientMetadata) {\n        if (clientMetadata === void 0) { clientMetadata = this._config.clientMetadata; }\n        if (!this.userPool) {\n            return this.rejectNoUserPool();\n        }\n        if (!username) {\n            return this.rejectAuthError(AuthErrorTypes.EmptyUsername);\n        }\n        var user = this.createCognitoUser(username);\n        return new Promise(function (resolve, reject) {\n            user.resendConfirmationCode(function (err, data) {\n                if (err) {\n                    reject(err);\n                }\n                else {\n                    resolve(data);\n                }\n            }, clientMetadata);\n        });\n    };\n    /**\n     * Sign in\n     * @param {String | SignInOpts} usernameOrSignInOpts - The username to be signed in or the sign in options\n     * @param {String} password - The password of the username\n     * @return - A promise resolves the CognitoUser\n     */\n    AuthClass.prototype.signIn = function (usernameOrSignInOpts, pw, clientMetadata) {\n        if (clientMetadata === void 0) { clientMetadata = this._config.clientMetadata; }\n        if (!this.userPool) {\n            return this.rejectNoUserPool();\n        }\n        var username = null;\n        var password = null;\n        var validationData = {};\n        // for backward compatibility\n        if (typeof usernameOrSignInOpts === 'string') {\n            username = usernameOrSignInOpts;\n            password = pw;\n        }\n        else if (isUsernamePasswordOpts(usernameOrSignInOpts)) {\n            if (typeof pw !== 'undefined') {\n                logger.warn('The password should be defined under the first parameter object!');\n            }\n            username = usernameOrSignInOpts.username;\n            password = usernameOrSignInOpts.password;\n            validationData = usernameOrSignInOpts.validationData;\n        }\n        else {\n            return this.rejectAuthError(AuthErrorTypes.InvalidUsername);\n        }\n        if (!username) {\n            return this.rejectAuthError(AuthErrorTypes.EmptyUsername);\n        }\n        var authDetails = new AuthenticationDetails({\n            Username: username,\n            Password: password,\n            ValidationData: validationData,\n            ClientMetadata: clientMetadata,\n        });\n        if (password) {\n            return this.signInWithPassword(authDetails);\n        }\n        else {\n            return this.signInWithoutPassword(authDetails);\n        }\n    };\n    /**\n     * Return an object with the authentication callbacks\n     * @param {CognitoUser} user - the cognito user object\n     * @param {} resolve - function called when resolving the current step\n     * @param {} reject - function called when rejecting the current step\n     * @return - an object with the callback methods for user authentication\n     */\n    AuthClass.prototype.authCallbacks = function (user, resolve, reject) {\n        var _this = this;\n        var that = this;\n        return {\n            onSuccess: function (session) { return __awaiter(_this, void 0, void 0, function () {\n                var cred, e_1, currentUser, e_2;\n                return __generator(this, function (_a) {\n                    switch (_a.label) {\n                        case 0:\n                            logger.debug(session);\n                            delete user['challengeName'];\n                            delete user['challengeParam'];\n                            _a.label = 1;\n                        case 1:\n                            _a.trys.push([1, 4, 5, 9]);\n                            return [4 /*yield*/, Credentials.clear()];\n                        case 2:\n                            _a.sent();\n                            return [4 /*yield*/, Credentials.set(session, 'session')];\n                        case 3:\n                            cred = _a.sent();\n                            logger.debug('succeed to get cognito credentials', cred);\n                            return [3 /*break*/, 9];\n                        case 4:\n                            e_1 = _a.sent();\n                            logger.debug('cannot get cognito credentials', e_1);\n                            return [3 /*break*/, 9];\n                        case 5:\n                            _a.trys.push([5, 7, , 8]);\n                            return [4 /*yield*/, this.currentUserPoolUser()];\n                        case 6:\n                            currentUser = _a.sent();\n                            that.user = currentUser;\n                            dispatchAuthEvent('signIn', currentUser, \"A user \" + user.getUsername() + \" has been signed in\");\n                            resolve(currentUser);\n                            return [3 /*break*/, 8];\n                        case 7:\n                            e_2 = _a.sent();\n                            logger.error('Failed to get the signed in user', e_2);\n                            reject(e_2);\n                            return [3 /*break*/, 8];\n                        case 8: return [7 /*endfinally*/];\n                        case 9: return [2 /*return*/];\n                    }\n                });\n            }); },\n            onFailure: function (err) {\n                logger.debug('signIn failure', err);\n                dispatchAuthEvent('signIn_failure', err, user.getUsername() + \" failed to signin\");\n                reject(err);\n            },\n            customChallenge: function (challengeParam) {\n                logger.debug('signIn custom challenge answer required');\n                user['challengeName'] = 'CUSTOM_CHALLENGE';\n                user['challengeParam'] = challengeParam;\n                resolve(user);\n            },\n            mfaRequired: function (challengeName, challengeParam) {\n                logger.debug('signIn MFA required');\n                user['challengeName'] = challengeName;\n                user['challengeParam'] = challengeParam;\n                resolve(user);\n            },\n            mfaSetup: function (challengeName, challengeParam) {\n                logger.debug('signIn mfa setup', challengeName);\n                user['challengeName'] = challengeName;\n                user['challengeParam'] = challengeParam;\n                resolve(user);\n            },\n            newPasswordRequired: function (userAttributes, requiredAttributes) {\n                logger.debug('signIn new password');\n                user['challengeName'] = 'NEW_PASSWORD_REQUIRED';\n                user['challengeParam'] = {\n                    userAttributes: userAttributes,\n                    requiredAttributes: requiredAttributes,\n                };\n                resolve(user);\n            },\n            totpRequired: function (challengeName, challengeParam) {\n                logger.debug('signIn totpRequired');\n                user['challengeName'] = challengeName;\n                user['challengeParam'] = challengeParam;\n                resolve(user);\n            },\n            selectMFAType: function (challengeName, challengeParam) {\n                logger.debug('signIn selectMFAType', challengeName);\n                user['challengeName'] = challengeName;\n                user['challengeParam'] = challengeParam;\n                resolve(user);\n            },\n        };\n    };\n    /**\n     * Sign in with a password\n     * @private\n     * @param {AuthenticationDetails} authDetails - the user sign in data\n     * @return - A promise resolves the CognitoUser object if success or mfa required\n     */\n    AuthClass.prototype.signInWithPassword = function (authDetails) {\n        var _this = this;\n        var user = this.createCognitoUser(authDetails.getUsername());\n        return new Promise(function (resolve, reject) {\n            user.authenticateUser(authDetails, _this.authCallbacks(user, resolve, reject));\n        });\n    };\n    /**\n     * Sign in without a password\n     * @private\n     * @param {AuthenticationDetails} authDetails - the user sign in data\n     * @return - A promise resolves the CognitoUser object if success or mfa required\n     */\n    AuthClass.prototype.signInWithoutPassword = function (authDetails) {\n        var _this = this;\n        var user = this.createCognitoUser(authDetails.getUsername());\n        user.setAuthenticationFlowType('CUSTOM_AUTH');\n        return new Promise(function (resolve, reject) {\n            user.initiateAuth(authDetails, _this.authCallbacks(user, resolve, reject));\n        });\n    };\n    /**\n     * get user current preferred mfa option\n     * this method doesn't work with totp, we need to deprecate it.\n     * @deprecated\n     * @param {CognitoUser} user - the current user\n     * @return - A promise resolves the current preferred mfa option if success\n     */\n    AuthClass.prototype.getMFAOptions = function (user) {\n        return new Promise(function (res, rej) {\n            user.getMFAOptions(function (err, mfaOptions) {\n                if (err) {\n                    logger.debug('get MFA Options failed', err);\n                    rej(err);\n                    return;\n                }\n                logger.debug('get MFA options success', mfaOptions);\n                res(mfaOptions);\n                return;\n            });\n        });\n    };\n    /**\n     * get preferred mfa method\n     * @param {CognitoUser} user - the current cognito user\n     * @param {GetPreferredMFAOpts} params - options for getting the current user preferred MFA\n     */\n    AuthClass.prototype.getPreferredMFA = function (user, params) {\n        var that = this;\n        return new Promise(function (res, rej) {\n            var bypassCache = params ? params.bypassCache : false;\n            user.getUserData(function (err, data) {\n                if (err) {\n                    logger.debug('getting preferred mfa failed', err);\n                    rej(err);\n                    return;\n                }\n                var mfaType = that._getMfaTypeFromUserData(data);\n                if (!mfaType) {\n                    rej('invalid MFA Type');\n                    return;\n                }\n                else {\n                    res(mfaType);\n                    return;\n                }\n            }, { bypassCache: bypassCache });\n        });\n    };\n    AuthClass.prototype._getMfaTypeFromUserData = function (data) {\n        var ret = null;\n        var preferredMFA = data.PreferredMfaSetting;\n        // if the user has used Auth.setPreferredMFA() to setup the mfa type\n        // then the \"PreferredMfaSetting\" would exist in the response\n        if (preferredMFA) {\n            ret = preferredMFA;\n        }\n        else {\n            // if mfaList exists but empty, then its noMFA\n            var mfaList = data.UserMFASettingList;\n            if (!mfaList) {\n                // if SMS was enabled by using Auth.enableSMS(),\n                // the response would contain MFAOptions\n                // as for now Cognito only supports for SMS, so we will say it is 'SMS_MFA'\n                // if it does not exist, then it should be NOMFA\n                var MFAOptions = data.MFAOptions;\n                if (MFAOptions) {\n                    ret = 'SMS_MFA';\n                }\n                else {\n                    ret = 'NOMFA';\n                }\n            }\n            else if (mfaList.length === 0) {\n                ret = 'NOMFA';\n            }\n            else {\n                logger.debug('invalid case for getPreferredMFA', data);\n            }\n        }\n        return ret;\n    };\n    AuthClass.prototype._getUserData = function (user, params) {\n        return new Promise(function (res, rej) {\n            user.getUserData(function (err, data) {\n                if (err) {\n                    logger.debug('getting user data failed', err);\n                    rej(err);\n                    return;\n                }\n                else {\n                    res(data);\n                    return;\n                }\n            }, params);\n        });\n    };\n    /**\n     * set preferred MFA method\n     * @param {CognitoUser} user - the current Cognito user\n     * @param {string} mfaMethod - preferred mfa method\n     * @return - A promise resolve if success\n     */\n    AuthClass.prototype.setPreferredMFA = function (user, mfaMethod) {\n        return __awaiter(this, void 0, void 0, function () {\n            var userData, smsMfaSettings, totpMfaSettings, _a, mfaList, currentMFAType, that;\n            return __generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0: return [4 /*yield*/, this._getUserData(user, { bypassCache: true })];\n                    case 1:\n                        userData = _b.sent();\n                        smsMfaSettings = null;\n                        totpMfaSettings = null;\n                        _a = mfaMethod;\n                        switch (_a) {\n                            case 'TOTP' || 'SOFTWARE_TOKEN_MFA': return [3 /*break*/, 2];\n                            case 'SMS' || 'SMS_MFA': return [3 /*break*/, 3];\n                            case 'NOMFA': return [3 /*break*/, 4];\n                        }\n                        return [3 /*break*/, 6];\n                    case 2:\n                        totpMfaSettings = {\n                            PreferredMfa: true,\n                            Enabled: true,\n                        };\n                        return [3 /*break*/, 7];\n                    case 3:\n                        smsMfaSettings = {\n                            PreferredMfa: true,\n                            Enabled: true,\n                        };\n                        return [3 /*break*/, 7];\n                    case 4:\n                        mfaList = userData['UserMFASettingList'];\n                        return [4 /*yield*/, this._getMfaTypeFromUserData(userData)];\n                    case 5:\n                        currentMFAType = _b.sent();\n                        if (currentMFAType === 'NOMFA') {\n                            return [2 /*return*/, Promise.resolve('No change for mfa type')];\n                        }\n                        else if (currentMFAType === 'SMS_MFA') {\n                            smsMfaSettings = {\n                                PreferredMfa: false,\n                                Enabled: false,\n                            };\n                        }\n                        else if (currentMFAType === 'SOFTWARE_TOKEN_MFA') {\n                            totpMfaSettings = {\n                                PreferredMfa: false,\n                                Enabled: false,\n                            };\n                        }\n                        else {\n                            return [2 /*return*/, this.rejectAuthError(AuthErrorTypes.InvalidMFA)];\n                        }\n                        // if there is a UserMFASettingList in the response\n                        // we need to disable every mfa type in that list\n                        if (mfaList && mfaList.length !== 0) {\n                            // to disable SMS or TOTP if exists in that list\n                            mfaList.forEach(function (mfaType) {\n                                if (mfaType === 'SMS_MFA') {\n                                    smsMfaSettings = {\n                                        PreferredMfa: false,\n                                        Enabled: false,\n                                    };\n                                }\n                                else if (mfaType === 'SOFTWARE_TOKEN_MFA') {\n                                    totpMfaSettings = {\n                                        PreferredMfa: false,\n                                        Enabled: false,\n                                    };\n                                }\n                            });\n                        }\n                        return [3 /*break*/, 7];\n                    case 6:\n                        logger.debug('no validmfa method provided');\n                        return [2 /*return*/, this.rejectAuthError(AuthErrorTypes.NoMFA)];\n                    case 7:\n                        that = this;\n                        return [2 /*return*/, new Promise(function (res, rej) {\n                                user.setUserMfaPreference(smsMfaSettings, totpMfaSettings, function (err, result) {\n                                    if (err) {\n                                        logger.debug('Set user mfa preference error', err);\n                                        return rej(err);\n                                    }\n                                    logger.debug('Set user mfa success', result);\n                                    logger.debug('Caching the latest user data into local');\n                                    // cache the latest result into user data\n                                    user.getUserData(function (err, data) {\n                                        if (err) {\n                                            logger.debug('getting user data failed', err);\n                                            return rej(err);\n                                        }\n                                        else {\n                                            return res(result);\n                                        }\n                                    }, { bypassCache: true });\n                                });\n                            })];\n                }\n            });\n        });\n    };\n    /**\n     * diable SMS\n     * @deprecated\n     * @param {CognitoUser} user - the current user\n     * @return - A promise resolves is success\n     */\n    AuthClass.prototype.disableSMS = function (user) {\n        return new Promise(function (res, rej) {\n            user.disableMFA(function (err, data) {\n                if (err) {\n                    logger.debug('disable mfa failed', err);\n                    rej(err);\n                    return;\n                }\n                logger.debug('disable mfa succeed', data);\n                res(data);\n                return;\n            });\n        });\n    };\n    /**\n     * enable SMS\n     * @deprecated\n     * @param {CognitoUser} user - the current user\n     * @return - A promise resolves is success\n     */\n    AuthClass.prototype.enableSMS = function (user) {\n        return new Promise(function (res, rej) {\n            user.enableMFA(function (err, data) {\n                if (err) {\n                    logger.debug('enable mfa failed', err);\n                    rej(err);\n                    return;\n                }\n                logger.debug('enable mfa succeed', data);\n                res(data);\n                return;\n            });\n        });\n    };\n    /**\n     * Setup TOTP\n     * @param {CognitoUser} user - the current user\n     * @return - A promise resolves with the secret code if success\n     */\n    AuthClass.prototype.setupTOTP = function (user) {\n        return new Promise(function (res, rej) {\n            user.associateSoftwareToken({\n                onFailure: function (err) {\n                    logger.debug('associateSoftwareToken failed', err);\n                    rej(err);\n                    return;\n                },\n                associateSecretCode: function (secretCode) {\n                    logger.debug('associateSoftwareToken sucess', secretCode);\n                    res(secretCode);\n                    return;\n                },\n            });\n        });\n    };\n    /**\n     * verify TOTP setup\n     * @param {CognitoUser} user - the current user\n     * @param {string} challengeAnswer - challenge answer\n     * @return - A promise resolves is success\n     */\n    AuthClass.prototype.verifyTotpToken = function (user, challengeAnswer) {\n        logger.debug('verfication totp token', user, challengeAnswer);\n        return new Promise(function (res, rej) {\n            user.verifySoftwareToken(challengeAnswer, 'My TOTP device', {\n                onFailure: function (err) {\n                    logger.debug('verifyTotpToken failed', err);\n                    rej(err);\n                    return;\n                },\n                onSuccess: function (data) {\n                    logger.debug('verifyTotpToken success', data);\n                    res(data);\n                    return;\n                },\n            });\n        });\n    };\n    /**\n     * Send MFA code to confirm sign in\n     * @param {Object} user - The CognitoUser object\n     * @param {String} code - The confirmation code\n     */\n    AuthClass.prototype.confirmSignIn = function (user, code, mfaType, clientMetadata) {\n        var _this = this;\n        if (clientMetadata === void 0) { clientMetadata = this._config.clientMetadata; }\n        if (!code) {\n            return this.rejectAuthError(AuthErrorTypes.EmptyCode);\n        }\n        var that = this;\n        return new Promise(function (resolve, reject) {\n            user.sendMFACode(code, {\n                onSuccess: function (session) { return __awaiter(_this, void 0, void 0, function () {\n                    var cred, e_3;\n                    return __generator(this, function (_a) {\n                        switch (_a.label) {\n                            case 0:\n                                logger.debug(session);\n                                _a.label = 1;\n                            case 1:\n                                _a.trys.push([1, 4, 5, 6]);\n                                return [4 /*yield*/, Credentials.clear()];\n                            case 2:\n                                _a.sent();\n                                return [4 /*yield*/, Credentials.set(session, 'session')];\n                            case 3:\n                                cred = _a.sent();\n                                logger.debug('succeed to get cognito credentials', cred);\n                                return [3 /*break*/, 6];\n                            case 4:\n                                e_3 = _a.sent();\n                                logger.debug('cannot get cognito credentials', e_3);\n                                return [3 /*break*/, 6];\n                            case 5:\n                                that.user = user;\n                                dispatchAuthEvent('signIn', user, user + \" has signed in\");\n                                resolve(user);\n                                return [7 /*endfinally*/];\n                            case 6: return [2 /*return*/];\n                        }\n                    });\n                }); },\n                onFailure: function (err) {\n                    logger.debug('confirm signIn failure', err);\n                    reject(err);\n                },\n            }, mfaType, clientMetadata);\n        });\n    };\n    AuthClass.prototype.completeNewPassword = function (user, password, requiredAttributes, clientMetadata) {\n        var _this = this;\n        if (clientMetadata === void 0) { clientMetadata = this._config.clientMetadata; }\n        if (!password) {\n            return this.rejectAuthError(AuthErrorTypes.EmptyPassword);\n        }\n        var that = this;\n        return new Promise(function (resolve, reject) {\n            user.completeNewPasswordChallenge(password, requiredAttributes, {\n                onSuccess: function (session) { return __awaiter(_this, void 0, void 0, function () {\n                    var cred, e_4;\n                    return __generator(this, function (_a) {\n                        switch (_a.label) {\n                            case 0:\n                                logger.debug(session);\n                                _a.label = 1;\n                            case 1:\n                                _a.trys.push([1, 4, 5, 6]);\n                                return [4 /*yield*/, Credentials.clear()];\n                            case 2:\n                                _a.sent();\n                                return [4 /*yield*/, Credentials.set(session, 'session')];\n                            case 3:\n                                cred = _a.sent();\n                                logger.debug('succeed to get cognito credentials', cred);\n                                return [3 /*break*/, 6];\n                            case 4:\n                                e_4 = _a.sent();\n                                logger.debug('cannot get cognito credentials', e_4);\n                                return [3 /*break*/, 6];\n                            case 5:\n                                that.user = user;\n                                dispatchAuthEvent('signIn', user, user + \" has signed in\");\n                                resolve(user);\n                                return [7 /*endfinally*/];\n                            case 6: return [2 /*return*/];\n                        }\n                    });\n                }); },\n                onFailure: function (err) {\n                    logger.debug('completeNewPassword failure', err);\n                    dispatchAuthEvent('completeNewPassword_failure', err, _this.user + \" failed to complete the new password flow\");\n                    reject(err);\n                },\n                mfaRequired: function (challengeName, challengeParam) {\n                    logger.debug('signIn MFA required');\n                    user['challengeName'] = challengeName;\n                    user['challengeParam'] = challengeParam;\n                    resolve(user);\n                },\n                mfaSetup: function (challengeName, challengeParam) {\n                    logger.debug('signIn mfa setup', challengeName);\n                    user['challengeName'] = challengeName;\n                    user['challengeParam'] = challengeParam;\n                    resolve(user);\n                },\n            }, clientMetadata);\n        });\n    };\n    /**\n     * Send the answer to a custom challenge\n     * @param {CognitoUser} user - The CognitoUser object\n     * @param {String} challengeResponses - The confirmation code\n     */\n    AuthClass.prototype.sendCustomChallengeAnswer = function (user, challengeResponses, clientMetadata) {\n        var _this = this;\n        if (clientMetadata === void 0) { clientMetadata = this._config.clientMetadata; }\n        if (!this.userPool) {\n            return this.rejectNoUserPool();\n        }\n        if (!challengeResponses) {\n            return this.rejectAuthError(AuthErrorTypes.EmptyChallengeResponse);\n        }\n        var that = this;\n        return new Promise(function (resolve, reject) {\n            user.sendCustomChallengeAnswer(challengeResponses, _this.authCallbacks(user, resolve, reject), clientMetadata);\n        });\n    };\n    /**\n     * Update an authenticated users' attributes\n     * @param {CognitoUser} - The currently logged in user object\n     * @return {Promise}\n     **/\n    AuthClass.prototype.updateUserAttributes = function (user, attributes, clientMetadata) {\n        if (clientMetadata === void 0) { clientMetadata = this._config.clientMetadata; }\n        var attributeList = [];\n        var that = this;\n        return new Promise(function (resolve, reject) {\n            that.userSession(user).then(function (session) {\n                for (var key in attributes) {\n                    if (key !== 'sub' && key.indexOf('_verified') < 0) {\n                        var attr = {\n                            Name: key,\n                            Value: attributes[key],\n                        };\n                        attributeList.push(attr);\n                    }\n                }\n                user.updateAttributes(attributeList, function (err, result) {\n                    if (err) {\n                        return reject(err);\n                    }\n                    else {\n                        return resolve(result);\n                    }\n                }, clientMetadata);\n            });\n        });\n    };\n    /**\n     * Return user attributes\n     * @param {Object} user - The CognitoUser object\n     * @return - A promise resolves to user attributes if success\n     */\n    AuthClass.prototype.userAttributes = function (user) {\n        var _this = this;\n        return new Promise(function (resolve, reject) {\n            _this.userSession(user).then(function (session) {\n                user.getUserAttributes(function (err, attributes) {\n                    if (err) {\n                        reject(err);\n                    }\n                    else {\n                        resolve(attributes);\n                    }\n                });\n            });\n        });\n    };\n    AuthClass.prototype.verifiedContact = function (user) {\n        var that = this;\n        return this.userAttributes(user).then(function (attributes) {\n            var attrs = that.attributesToObject(attributes);\n            var unverified = {};\n            var verified = {};\n            if (attrs['email']) {\n                if (attrs['email_verified']) {\n                    verified['email'] = attrs['email'];\n                }\n                else {\n                    unverified['email'] = attrs['email'];\n                }\n            }\n            if (attrs['phone_number']) {\n                if (attrs['phone_number_verified']) {\n                    verified['phone_number'] = attrs['phone_number'];\n                }\n                else {\n                    unverified['phone_number'] = attrs['phone_number'];\n                }\n            }\n            return {\n                verified: verified,\n                unverified: unverified,\n            };\n        });\n    };\n    /**\n     * Get current authenticated user\n     * @return - A promise resolves to current authenticated CognitoUser if success\n     */\n    AuthClass.prototype.currentUserPoolUser = function (params) {\n        var _this = this;\n        if (!this.userPool) {\n            return this.rejectNoUserPool();\n        }\n        var that = this;\n        return new Promise(function (res, rej) {\n            _this._storageSync\n                .then(function () {\n                var user = that.userPool.getCurrentUser();\n                if (!user) {\n                    logger.debug('Failed to get user from user pool');\n                    rej('No current user');\n                    return;\n                }\n                // refresh the session if the session expired.\n                user.getSession(function (err, session) {\n                    if (err) {\n                        logger.debug('Failed to get the user session', err);\n                        rej(err);\n                        return;\n                    }\n                    // get user data from Cognito\n                    var bypassCache = params ? params.bypassCache : false;\n                    // validate the token's scope fisrt before calling this function\n                    var _a = session.getAccessToken().decodePayload().scope, scope = _a === void 0 ? '' : _a;\n                    if (scope.split(' ').includes(USER_ADMIN_SCOPE)) {\n                        user.getUserData(function (err, data) {\n                            if (err) {\n                                logger.debug('getting user data failed', err);\n                                // Make sure the user is still valid\n                                if (err.message === 'User is disabled' ||\n                                    err.message === 'User does not exist.') {\n                                    rej(err);\n                                }\n                                else {\n                                    // the error may also be thrown when lack of permissions to get user info etc\n                                    // in that case we just bypass the error\n                                    res(user);\n                                }\n                                return;\n                            }\n                            var preferredMFA = data.PreferredMfaSetting || 'NOMFA';\n                            var attributeList = [];\n                            for (var i = 0; i < data.UserAttributes.length; i++) {\n                                var attribute = {\n                                    Name: data.UserAttributes[i].Name,\n                                    Value: data.UserAttributes[i].Value,\n                                };\n                                var userAttribute = new CognitoUserAttribute(attribute);\n                                attributeList.push(userAttribute);\n                            }\n                            var attributes = that.attributesToObject(attributeList);\n                            Object.assign(user, { attributes: attributes, preferredMFA: preferredMFA });\n                            return res(user);\n                        }, { bypassCache: bypassCache });\n                    }\n                    else {\n                        logger.debug(\"Unable to get the user data because the \" + USER_ADMIN_SCOPE + \" \" +\n                            \"is not in the scopes of the access token\");\n                        return res(user);\n                    }\n                });\n            })\n                .catch(function (e) {\n                logger.debug('Failed to sync cache info into memory', e);\n                return rej(e);\n            });\n        });\n    };\n    /**\n     * Get current authenticated user\n     * @param {CurrentUserOpts} - options for getting the current user\n     * @return - A promise resolves to current authenticated CognitoUser if success\n     */\n    AuthClass.prototype.currentAuthenticatedUser = function (params) {\n        return __awaiter(this, void 0, void 0, function () {\n            var federatedUser, e_5, user, e_6;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        logger.debug('getting current authenticated user');\n                        federatedUser = null;\n                        _a.label = 1;\n                    case 1:\n                        _a.trys.push([1, 3, , 4]);\n                        return [4 /*yield*/, this._storageSync];\n                    case 2:\n                        _a.sent();\n                        return [3 /*break*/, 4];\n                    case 3:\n                        e_5 = _a.sent();\n                        logger.debug('Failed to sync cache info into memory', e_5);\n                        throw e_5;\n                    case 4:\n                        try {\n                            federatedUser = JSON.parse(this._storage.getItem('aws-amplify-federatedInfo')).user;\n                        }\n                        catch (e) {\n                            logger.debug('cannot load federated user from auth storage');\n                        }\n                        if (!federatedUser) return [3 /*break*/, 5];\n                        this.user = federatedUser;\n                        logger.debug('get current authenticated federated user', this.user);\n                        return [2 /*return*/, this.user];\n                    case 5:\n                        logger.debug('get current authenticated userpool user');\n                        user = null;\n                        _a.label = 6;\n                    case 6:\n                        _a.trys.push([6, 8, , 9]);\n                        return [4 /*yield*/, this.currentUserPoolUser(params)];\n                    case 7:\n                        user = _a.sent();\n                        return [3 /*break*/, 9];\n                    case 8:\n                        e_6 = _a.sent();\n                        if (e_6 === 'No userPool') {\n                            logger.error('Cannot get the current user because the user pool is missing. ' +\n                                'Please make sure the Auth module is configured with a valid Cognito User Pool ID');\n                        }\n                        logger.debug('The user is not authenticated by the error', e_6);\n                        throw 'not authenticated';\n                    case 9:\n                        this.user = user;\n                        return [2 /*return*/, this.user];\n                }\n            });\n        });\n    };\n    /**\n     * Get current user's session\n     * @return - A promise resolves to session object if success\n     */\n    AuthClass.prototype.currentSession = function () {\n        var that = this;\n        logger.debug('Getting current session');\n        // Purposely not calling the reject method here because we don't need a console error\n        if (!this.userPool) {\n            return Promise.reject();\n        }\n        return new Promise(function (res, rej) {\n            that\n                .currentUserPoolUser()\n                .then(function (user) {\n                that\n                    .userSession(user)\n                    .then(function (session) {\n                    res(session);\n                    return;\n                })\n                    .catch(function (e) {\n                    logger.debug('Failed to get the current session', e);\n                    rej(e);\n                    return;\n                });\n            })\n                .catch(function (e) {\n                logger.debug('Failed to get the current user', e);\n                rej(e);\n                return;\n            });\n        });\n    };\n    /**\n     * Get the corresponding user session\n     * @param {Object} user - The CognitoUser object\n     * @return - A promise resolves to the session\n     */\n    AuthClass.prototype.userSession = function (user) {\n        if (!user) {\n            logger.debug('the user is null');\n            return this.rejectAuthError(AuthErrorTypes.NoUserSession);\n        }\n        return new Promise(function (resolve, reject) {\n            logger.debug('Getting the session from this user:', user);\n            user.getSession(function (err, session) {\n                if (err) {\n                    logger.debug('Failed to get the session from user', user);\n                    reject(err);\n                    return;\n                }\n                else {\n                    logger.debug('Succeed to get the user session', session);\n                    resolve(session);\n                    return;\n                }\n            });\n        });\n    };\n    /**\n     * Get  authenticated credentials of current user.\n     * @return - A promise resolves to be current user's credentials\n     */\n    AuthClass.prototype.currentUserCredentials = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            var that, e_7, federatedInfo;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        that = this;\n                        logger.debug('Getting current user credentials');\n                        _a.label = 1;\n                    case 1:\n                        _a.trys.push([1, 3, , 4]);\n                        return [4 /*yield*/, this._storageSync];\n                    case 2:\n                        _a.sent();\n                        return [3 /*break*/, 4];\n                    case 3:\n                        e_7 = _a.sent();\n                        logger.debug('Failed to sync cache info into memory', e_7);\n                        throw e_7;\n                    case 4:\n                        federatedInfo = null;\n                        try {\n                            federatedInfo = JSON.parse(this._storage.getItem('aws-amplify-federatedInfo'));\n                        }\n                        catch (e) {\n                            logger.debug('failed to get or parse item aws-amplify-federatedInfo', e);\n                        }\n                        if (federatedInfo) {\n                            // refresh the jwt token here if necessary\n                            return [2 /*return*/, Credentials.refreshFederatedToken(federatedInfo)];\n                        }\n                        else {\n                            return [2 /*return*/, this.currentSession()\n                                    .then(function (session) {\n                                    logger.debug('getting session success', session);\n                                    return Credentials.set(session, 'session');\n                                })\n                                    .catch(function (error) {\n                                    logger.debug('getting session failed', error);\n                                    return Credentials.set(null, 'guest');\n                                })];\n                        }\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    AuthClass.prototype.currentCredentials = function () {\n        logger.debug('getting current credntials');\n        return Credentials.get();\n    };\n    /**\n     * Initiate an attribute confirmation request\n     * @param {Object} user - The CognitoUser\n     * @param {Object} attr - The attributes to be verified\n     * @return - A promise resolves to callback data if success\n     */\n    AuthClass.prototype.verifyUserAttribute = function (user, attr, clientMetadata) {\n        if (clientMetadata === void 0) { clientMetadata = this._config.clientMetadata; }\n        return new Promise(function (resolve, reject) {\n            user.getAttributeVerificationCode(attr, {\n                onSuccess: function () {\n                    return resolve();\n                },\n                onFailure: function (err) {\n                    return reject(err);\n                },\n                clientMetadata: clientMetadata,\n            });\n        });\n    };\n    /**\n     * Confirm an attribute using a confirmation code\n     * @param {Object} user - The CognitoUser\n     * @param {Object} attr - The attribute to be verified\n     * @param {String} code - The confirmation code\n     * @return - A promise resolves to callback data if success\n     */\n    AuthClass.prototype.verifyUserAttributeSubmit = function (user, attr, code) {\n        if (!code) {\n            return this.rejectAuthError(AuthErrorTypes.EmptyCode);\n        }\n        return new Promise(function (resolve, reject) {\n            user.verifyAttribute(attr, code, {\n                onSuccess: function (data) {\n                    resolve(data);\n                    return;\n                },\n                onFailure: function (err) {\n                    reject(err);\n                    return;\n                },\n            });\n        });\n    };\n    AuthClass.prototype.verifyCurrentUserAttribute = function (attr) {\n        var that = this;\n        return that\n            .currentUserPoolUser()\n            .then(function (user) { return that.verifyUserAttribute(user, attr); });\n    };\n    /**\n     * Confirm current user's attribute using a confirmation code\n     * @param {Object} attr - The attribute to be verified\n     * @param {String} code - The confirmation code\n     * @return - A promise resolves to callback data if success\n     */\n    AuthClass.prototype.verifyCurrentUserAttributeSubmit = function (attr, code) {\n        var that = this;\n        return that\n            .currentUserPoolUser()\n            .then(function (user) { return that.verifyUserAttributeSubmit(user, attr, code); });\n    };\n    AuthClass.prototype.cognitoIdentitySignOut = function (opts, user) {\n        return __awaiter(this, void 0, void 0, function () {\n            var e_8, isSignedInHostedUI;\n            var _this = this;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        _a.trys.push([0, 2, , 3]);\n                        return [4 /*yield*/, this._storageSync];\n                    case 1:\n                        _a.sent();\n                        return [3 /*break*/, 3];\n                    case 2:\n                        e_8 = _a.sent();\n                        logger.debug('Failed to sync cache info into memory', e_8);\n                        throw e_8;\n                    case 3:\n                        isSignedInHostedUI = this._oAuthHandler &&\n                            this._storage.getItem('amplify-signin-with-hostedUI') === 'true';\n                        return [2 /*return*/, new Promise(function (res, rej) {\n                                if (opts && opts.global) {\n                                    logger.debug('user global sign out', user);\n                                    // in order to use global signout\n                                    // we must validate the user as an authenticated user by using getSession\n                                    user.getSession(function (err, result) {\n                                        if (err) {\n                                            logger.debug('failed to get the user session', err);\n                                            return rej(err);\n                                        }\n                                        user.globalSignOut({\n                                            onSuccess: function (data) {\n                                                logger.debug('global sign out success');\n                                                if (isSignedInHostedUI) {\n                                                    return res(_this._oAuthHandler.signOut());\n                                                }\n                                                else {\n                                                    return res();\n                                                }\n                                            },\n                                            onFailure: function (err) {\n                                                logger.debug('global sign out failed', err);\n                                                return rej(err);\n                                            },\n                                        });\n                                    });\n                                }\n                                else {\n                                    logger.debug('user sign out', user);\n                                    user.signOut();\n                                    if (isSignedInHostedUI) {\n                                        return res(_this._oAuthHandler.signOut());\n                                    }\n                                    else {\n                                        return res();\n                                    }\n                                }\n                            })];\n                }\n            });\n        });\n    };\n    /**\n     * Sign out method\n     * @\n     * @return - A promise resolved if success\n     */\n    AuthClass.prototype.signOut = function (opts) {\n        return __awaiter(this, void 0, void 0, function () {\n            var e_9, user;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        _a.trys.push([0, 2, , 3]);\n                        return [4 /*yield*/, this.cleanCachedItems()];\n                    case 1:\n                        _a.sent();\n                        return [3 /*break*/, 3];\n                    case 2:\n                        e_9 = _a.sent();\n                        logger.debug('failed to clear cached items');\n                        return [3 /*break*/, 3];\n                    case 3:\n                        if (!this.userPool) return [3 /*break*/, 7];\n                        user = this.userPool.getCurrentUser();\n                        if (!user) return [3 /*break*/, 5];\n                        return [4 /*yield*/, this.cognitoIdentitySignOut(opts, user)];\n                    case 4:\n                        _a.sent();\n                        return [3 /*break*/, 6];\n                    case 5:\n                        logger.debug('no current Cognito user');\n                        _a.label = 6;\n                    case 6: return [3 /*break*/, 8];\n                    case 7:\n                        logger.debug('no Congito User pool');\n                        _a.label = 8;\n                    case 8:\n                        /**\n                         * Note for future refactor - no reliable way to get username with\n                         * Cognito User Pools vs Identity when federating with Social Providers\n                         * This is why we need a well structured session object that can be inspected\n                         * and information passed back in the message below for Hub dispatch\n                         */\n                        dispatchAuthEvent('signOut', this.user, \"A user has been signed out\");\n                        this.user = null;\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    AuthClass.prototype.cleanCachedItems = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: \n                    // clear cognito cached item\n                    return [4 /*yield*/, Credentials.clear()];\n                    case 1:\n                        // clear cognito cached item\n                        _a.sent();\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    /**\n     * Change a password for an authenticated user\n     * @param {Object} user - The CognitoUser object\n     * @param {String} oldPassword - the current password\n     * @param {String} newPassword - the requested new password\n     * @return - A promise resolves if success\n     */\n    AuthClass.prototype.changePassword = function (user, oldPassword, newPassword, clientMetadata) {\n        var _this = this;\n        if (clientMetadata === void 0) { clientMetadata = this._config.clientMetadata; }\n        return new Promise(function (resolve, reject) {\n            _this.userSession(user).then(function (session) {\n                user.changePassword(oldPassword, newPassword, function (err, data) {\n                    if (err) {\n                        logger.debug('change password failure', err);\n                        return reject(err);\n                    }\n                    else {\n                        return resolve(data);\n                    }\n                }, clientMetadata);\n            });\n        });\n    };\n    /**\n     * Initiate a forgot password request\n     * @param {String} username - the username to change password\n     * @return - A promise resolves if success\n     */\n    AuthClass.prototype.forgotPassword = function (username, clientMetadata) {\n        if (clientMetadata === void 0) { clientMetadata = this._config.clientMetadata; }\n        if (!this.userPool) {\n            return this.rejectNoUserPool();\n        }\n        if (!username) {\n            return this.rejectAuthError(AuthErrorTypes.EmptyUsername);\n        }\n        var user = this.createCognitoUser(username);\n        return new Promise(function (resolve, reject) {\n            user.forgotPassword({\n                onSuccess: function () {\n                    resolve();\n                    return;\n                },\n                onFailure: function (err) {\n                    logger.debug('forgot password failure', err);\n                    dispatchAuthEvent('forgotPassword_failure', err, username + \" forgotPassword failed\");\n                    reject(err);\n                    return;\n                },\n                inputVerificationCode: function (data) {\n                    dispatchAuthEvent('forgotPassword', user, username + \" has initiated forgot password flow\");\n                    resolve(data);\n                    return;\n                },\n            }, clientMetadata);\n        });\n    };\n    /**\n     * Confirm a new password using a confirmation Code\n     * @param {String} username - The username\n     * @param {String} code - The confirmation code\n     * @param {String} password - The new password\n     * @return - A promise that resolves if success\n     */\n    AuthClass.prototype.forgotPasswordSubmit = function (username, code, password, clientMetadata) {\n        if (clientMetadata === void 0) { clientMetadata = this._config.clientMetadata; }\n        if (!this.userPool) {\n            return this.rejectNoUserPool();\n        }\n        if (!username) {\n            return this.rejectAuthError(AuthErrorTypes.EmptyUsername);\n        }\n        if (!code) {\n            return this.rejectAuthError(AuthErrorTypes.EmptyCode);\n        }\n        if (!password) {\n            return this.rejectAuthError(AuthErrorTypes.EmptyPassword);\n        }\n        var user = this.createCognitoUser(username);\n        return new Promise(function (resolve, reject) {\n            user.confirmPassword(code, password, {\n                onSuccess: function () {\n                    dispatchAuthEvent('forgotPasswordSubmit', user, username + \" forgotPasswordSubmit successful\");\n                    resolve();\n                    return;\n                },\n                onFailure: function (err) {\n                    dispatchAuthEvent('forgotPasswordSubmit_failure', err, username + \" forgotPasswordSubmit failed\");\n                    reject(err);\n                    return;\n                },\n            }, clientMetadata);\n        });\n    };\n    /**\n     * Get user information\n     * @async\n     * @return {Object }- current User's information\n     */\n    AuthClass.prototype.currentUserInfo = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            var source, user, attributes, userAttrs, credentials, e_10, info, err_1, user;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        source = Credentials.getCredSource();\n                        if (!(!source || source === 'aws' || source === 'userPool')) return [3 /*break*/, 9];\n                        return [4 /*yield*/, this.currentUserPoolUser().catch(function (err) {\n                                return logger.debug(err);\n                            })];\n                    case 1:\n                        user = _a.sent();\n                        if (!user) {\n                            return [2 /*return*/, null];\n                        }\n                        _a.label = 2;\n                    case 2:\n                        _a.trys.push([2, 8, , 9]);\n                        return [4 /*yield*/, this.userAttributes(user)];\n                    case 3:\n                        attributes = _a.sent();\n                        userAttrs = this.attributesToObject(attributes);\n                        credentials = null;\n                        _a.label = 4;\n                    case 4:\n                        _a.trys.push([4, 6, , 7]);\n                        return [4 /*yield*/, this.currentCredentials()];\n                    case 5:\n                        credentials = _a.sent();\n                        return [3 /*break*/, 7];\n                    case 6:\n                        e_10 = _a.sent();\n                        logger.debug('Failed to retrieve credentials while getting current user info', e_10);\n                        return [3 /*break*/, 7];\n                    case 7:\n                        info = {\n                            id: credentials ? credentials.identityId : undefined,\n                            username: user.getUsername(),\n                            attributes: userAttrs,\n                        };\n                        return [2 /*return*/, info];\n                    case 8:\n                        err_1 = _a.sent();\n                        logger.debug('currentUserInfo error', err_1);\n                        return [2 /*return*/, {}];\n                    case 9:\n                        if (source === 'federated') {\n                            user = this.user;\n                            return [2 /*return*/, user ? user : {}];\n                        }\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    AuthClass.prototype.federatedSignIn = function (providerOrOptions, response, user) {\n        return __awaiter(this, void 0, void 0, function () {\n            var options, provider, customState, client_id, redirect_uri, provider, loggedInUser, token, identity_id, expires_at, credentials, currentUser;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        if (!this._config.identityPoolId && !this._config.userPoolId) {\n                            throw new Error(\"Federation requires either a User Pool or Identity Pool in config\");\n                        }\n                        // Ensure backwards compatability\n                        if (typeof providerOrOptions === 'undefined') {\n                            if (this._config.identityPoolId && !this._config.userPoolId) {\n                                throw new Error(\"Federation with Identity Pools requires tokens passed as arguments\");\n                            }\n                        }\n                        if (!(isFederatedSignInOptions(providerOrOptions) ||\n                            isFederatedSignInOptionsCustom(providerOrOptions) ||\n                            typeof providerOrOptions === 'undefined')) return [3 /*break*/, 1];\n                        options = providerOrOptions || {\n                            provider: CognitoHostedUIIdentityProvider.Cognito,\n                        };\n                        provider = isFederatedSignInOptions(options)\n                            ? options.provider\n                            : options.customProvider;\n                        customState = isFederatedSignInOptions(options)\n                            ? options.customState\n                            : options.customState;\n                        if (this._config.userPoolId) {\n                            client_id = isCognitoHostedOpts(this._config.oauth)\n                                ? this._config.userPoolWebClientId\n                                : this._config.oauth.clientID;\n                            redirect_uri = isCognitoHostedOpts(this._config.oauth)\n                                ? this._config.oauth.redirectSignIn\n                                : this._config.oauth.redirectUri;\n                            this._oAuthHandler.oauthSignIn(this._config.oauth.responseType, this._config.oauth.domain, redirect_uri, client_id, provider, customState);\n                        }\n                        return [3 /*break*/, 4];\n                    case 1:\n                        provider = providerOrOptions;\n                        // To check if the user is already logged in\n                        try {\n                            loggedInUser = JSON.stringify(JSON.parse(this._storage.getItem('aws-amplify-federatedInfo')).user);\n                            if (loggedInUser) {\n                                logger.warn(\"There is already a signed in user: \" + loggedInUser + \" in your app.\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tYou should not call Auth.federatedSignIn method again as it may cause unexpected behavior.\");\n                            }\n                        }\n                        catch (e) { }\n                        token = response.token, identity_id = response.identity_id, expires_at = response.expires_at;\n                        return [4 /*yield*/, Credentials.set({ provider: provider, token: token, identity_id: identity_id, user: user, expires_at: expires_at }, 'federation')];\n                    case 2:\n                        credentials = _a.sent();\n                        return [4 /*yield*/, this.currentAuthenticatedUser()];\n                    case 3:\n                        currentUser = _a.sent();\n                        dispatchAuthEvent('signIn', currentUser, \"A user \" + currentUser.username + \" has been signed in\");\n                        logger.debug('federated sign in credentials', credentials);\n                        return [2 /*return*/, credentials];\n                    case 4: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    /**\n     * Used to complete the OAuth flow with or without the Cognito Hosted UI\n     * @param {String} URL - optional parameter for customers to pass in the response URL\n     */\n    AuthClass.prototype._handleAuthResponse = function (URL) {\n        return __awaiter(this, void 0, void 0, function () {\n            var currentUrl, hasCodeOrError, hasTokenOrError, _a, accessToken, idToken, refreshToken, state, session, credentials, isCustomStateIncluded, currentUser, _b, customState, err_2;\n            return __generator(this, function (_c) {\n                switch (_c.label) {\n                    case 0:\n                        if (!this._config.userPoolId) {\n                            throw new Error(\"OAuth responses require a User Pool defined in config\");\n                        }\n                        dispatchAuthEvent('parsingCallbackUrl', { url: URL }, \"The callback url is being parsed\");\n                        currentUrl = URL || (JS.browserOrNode().isBrowser ? window.location.href : '');\n                        hasCodeOrError = !!(parse(currentUrl).query || '')\n                            .split('&')\n                            .map(function (entry) { return entry.split('='); })\n                            .find(function (_a) {\n                            var k = _a[0];\n                            return k === 'code' || k === 'error';\n                        });\n                        hasTokenOrError = !!(parse(currentUrl).hash || '#')\n                            .substr(1)\n                            .split('&')\n                            .map(function (entry) { return entry.split('='); })\n                            .find(function (_a) {\n                            var k = _a[0];\n                            return k === 'access_token' || k === 'error';\n                        });\n                        if (!(hasCodeOrError || hasTokenOrError)) return [3 /*break*/, 6];\n                        _c.label = 1;\n                    case 1:\n                        _c.trys.push([1, 5, , 6]);\n                        return [4 /*yield*/, this._oAuthHandler.handleAuthResponse(currentUrl)];\n                    case 2:\n                        _a = _c.sent(), accessToken = _a.accessToken, idToken = _a.idToken, refreshToken = _a.refreshToken, state = _a.state;\n                        session = new CognitoUserSession({\n                            IdToken: new CognitoIdToken({ IdToken: idToken }),\n                            RefreshToken: new CognitoRefreshToken({ RefreshToken: refreshToken }),\n                            AccessToken: new CognitoAccessToken({ AccessToken: accessToken }),\n                        });\n                        credentials = void 0;\n                        if (!this._config.identityPoolId) return [3 /*break*/, 4];\n                        return [4 /*yield*/, Credentials.set(session, 'session')];\n                    case 3:\n                        credentials = _c.sent();\n                        logger.debug('AWS credentials', credentials);\n                        _c.label = 4;\n                    case 4:\n                        isCustomStateIncluded = /-/.test(state);\n                        currentUser = this.createCognitoUser(session.getIdToken().decodePayload()['cognito:username']);\n                        dispatchAuthEvent('signIn', currentUser, \"A user \" + currentUser.getUsername() + \" has been signed in\");\n                        dispatchAuthEvent('cognitoHostedUI', currentUser, \"A user \" + currentUser.getUsername() + \" has been signed in via Cognito Hosted UI\");\n                        if (isCustomStateIncluded) {\n                            _b = state.split('-'), customState = _b[1];\n                            dispatchAuthEvent('customOAuthState', customState, \"State for user \" + currentUser.getUsername());\n                        }\n                        // This calls cacheTokens() in Cognito SDK\n                        currentUser.setSignInUserSession(session);\n                        //#endregion\n                        if (window && typeof window.history !== 'undefined') {\n                            window.history.replaceState({}, null, this._config.oauth.redirectSignIn);\n                        }\n                        return [2 /*return*/, credentials];\n                    case 5:\n                        err_2 = _c.sent();\n                        logger.debug('Error in cognito hosted auth response', err_2);\n                        dispatchAuthEvent('signIn_failure', err_2, \"The OAuth response flow failed\");\n                        dispatchAuthEvent('cognitoHostedUI_failure', err_2, \"A failure occurred when returning to the Cognito Hosted UI\");\n                        dispatchAuthEvent('customState_failure', err_2, \"A failure occurred when returning state\");\n                        throw err_2;\n                    case 6: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    /**\n     * Compact version of credentials\n     * @param {Object} credentials\n     * @return {Object} - Credentials\n     */\n    AuthClass.prototype.essentialCredentials = function (credentials) {\n        return {\n            accessKeyId: credentials.accessKeyId,\n            sessionToken: credentials.sessionToken,\n            secretAccessKey: credentials.secretAccessKey,\n            identityId: credentials.identityId,\n            authenticated: credentials.authenticated,\n        };\n    };\n    AuthClass.prototype.attributesToObject = function (attributes) {\n        var obj = {};\n        if (attributes) {\n            attributes.map(function (attribute) {\n                if (attribute.Value === 'true') {\n                    obj[attribute.Name] = true;\n                }\n                else if (attribute.Value === 'false') {\n                    obj[attribute.Name] = false;\n                }\n                else {\n                    obj[attribute.Name] = attribute.Value;\n                }\n            });\n        }\n        return obj;\n    };\n    AuthClass.prototype.createCognitoUser = function (username) {\n        var userData = {\n            Username: username,\n            Pool: this.userPool,\n        };\n        userData.Storage = this._storage;\n        var authenticationFlowType = this._config.authenticationFlowType;\n        var user = new CognitoUser(userData);\n        if (authenticationFlowType) {\n            user.setAuthenticationFlowType(authenticationFlowType);\n        }\n        return user;\n    };\n    AuthClass.prototype._isValidAuthStorage = function (obj) {\n        // We need to check if the obj has the functions of Storage\n        return (!!obj &&\n            typeof obj.getItem === 'function' &&\n            typeof obj.setItem === 'function' &&\n            typeof obj.removeItem === 'function' &&\n            typeof obj.clear === 'function');\n    };\n    AuthClass.prototype.noUserPoolErrorHandler = function (config) {\n        if (config) {\n            if (!config.userPoolId || !config.identityPoolId) {\n                return AuthErrorTypes.MissingAuthConfig;\n            }\n        }\n        return AuthErrorTypes.NoConfig;\n    };\n    AuthClass.prototype.rejectAuthError = function (type) {\n        return Promise.reject(new AuthError(type));\n    };\n    AuthClass.prototype.rejectNoUserPool = function () {\n        var type = this.noUserPoolErrorHandler(this._config);\n        return Promise.reject(new NoUserPoolError(type));\n    };\n    return AuthClass;\n}());\nexport default AuthClass;\n//# sourceMappingURL=Auth.js.map"]},"metadata":{},"sourceType":"module"}